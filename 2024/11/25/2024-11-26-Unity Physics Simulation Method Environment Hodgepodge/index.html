<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Unity Euler and Position based Simulation Methods together with languages Hodgepodge | Ayin</title><meta name="author" content="YiZhen"><meta name="copyright" content="YiZhen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Multi-directional comparison of simulation methods and environments">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity Euler and Position based Simulation Methods together with languages Hodgepodge">
<meta property="og:url" content="https://ayinzhang.github.io/en/2024/11/25/2024-11-26-Unity%20Physics%20Simulation%20Method%20Environment%20Hodgepodge/index.html">
<meta property="og:site_name" content="Ayin">
<meta property="og:description" content="Multi-directional comparison of simulation methods and environments">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pica.zhimg.com/70/v2-f6bca2be2f713b9248d0def917d533b3_1440w.avis?source=172ae18b&biz_tag=Post">
<meta property="article:published_time" content="2024-11-25T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-31T18:26:49.156Z">
<meta property="article:author" content="YiZhen">
<meta property="article:tag" content="Animated simulation">
<meta property="article:tag" content="MultiThread">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pica.zhimg.com/70/v2-f6bca2be2f713b9248d0def917d533b3_1440w.avis?source=172ae18b&biz_tag=Post"><link rel="shortcut icon" href="https://fastly.jsdelivr.net/gh/ayinzhang/ayinzhang.github.io/img/icon.png"><link rel="canonical" href="https://ayinzhang.github.io/en/2024/11/25/2024-11-26-Unity%20Physics%20Simulation%20Method%20Environment%20Hodgepodge/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/en/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f74029fa7cc77ea7995800ef7950497d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/en/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"EN","msgToSimplifiedChinese":"ZH"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Unity Euler and Position based Simulation Methods together with languages Hodgepodge',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-04-01 02:26:49'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/en/img/me.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">19</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/en/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/en/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/en/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="https://ayinzhang.github.io/"><i class="fa-fw fas fa-c"></i><span> Language</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pica.zhimg.com/70/v2-f6bca2be2f713b9248d0def917d533b3_1440w.avis?source=172ae18b&amp;biz_tag=Post')"><nav id="nav"><span id="blog-info"><a href="/en/" title="Ayin"><span class="site-name">Ayin</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/en/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/en/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/en/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="https://ayinzhang.github.io/"><i class="fa-fw fas fa-c"></i><span> Language</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Unity Euler and Position based Simulation Methods together with languages Hodgepodge</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-11-25T16:00:00.000Z" title="Created 2024-11-26 00:00:00">2024-11-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-03-31T18:26:49.156Z" title="Updated 2025-04-01 02:26:49">2025-04-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/en/categories/Technology-sharing/">Technology sharing</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/en/categories/Technology-sharing/Unity-related/">Unity related</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Unity Euler and Position based Simulation Methods together with languages Hodgepodge"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="Comparison-Overview"><a href="#Comparison-Overview" class="headerlink" title="Comparison Overview"></a>Comparison Overview</h3><p>It was only when I was writing the title that I realized how miscellaneous my work was… Taking advantage of the need to select a paper for a school symposium, I chose PBD and XPBD, and also did a comparison between those and tradition PBA. I remembered that I had always wanted to compare the performance of C# and C++ during my internship but never did, so I wrote two comparisons of the semi-implicit method in Unity and C++ respectively (how can I miss parallelization). Here is a general comparison table first. The specific values don’t make much sense, but it’s still okay to look at the trend. (35x35 cloth grid, 2000 stiffness coefficient, 32 iterations, 64 threads, GTX1650 laptop. Parallelism is all lock-free multi-threading)</p>
<table>
<thead>
<tr>
<th></th>
<th>Unity</th>
<th>Unity Job + Burst</th>
<th>C++</th>
<th>C++ Thread</th>
</tr>
</thead>
<tbody><tr>
<td>Time (ms)</td>
<td>5.6</td>
<td>0.47</td>
<td>0.56</td>
<td>0.76</td>
</tr>
</tbody></table>
<p>The performance of C++ Thread is a bit unexpected. I think it might be because Thread too costly? However, the performance of C++ is much better than Unity. I think I can try C++ when I want to optimize the code that is not suitable for Job + Burst parallelization the next time.</p>
<table>
<thead>
<tr>
<th></th>
<th>Semi-Implicit Euler</th>
<th>Implicit Euler</th>
<th>PBD</th>
<th>XPBD</th>
</tr>
</thead>
<tbody><tr>
<td>Main Thread (ms)</td>
<td>5.6</td>
<td>6.0</td>
<td>11.2</td>
<td>8.7</td>
</tr>
<tr>
<td>Job + Burst (ms)</td>
<td>0.47</td>
<td>0.58</td>
<td>0.48</td>
<td>0.68</td>
</tr>
</tbody></table>
<p>Implicit crashes and not be taken into account. XPBD is better than PBD in the main thread may because I used Jacobi instead of Gauss-Seidel when writing PBD, but just look at the parallelization. What disappoint me is that Unity’s Cloth component only needs 0.2ms to simulate these, while my PBD can only reach 0.4ms while maintaining stability. I will study how to optimize it later when I have time</p>
<h3 id="Semi-Implicit-Euler"><a href="#Semi-Implicit-Euler" class="headerlink" title="Semi-Implicit Euler"></a>Semi-Implicit Euler</h3><p>I wanted to write an explicit one at the begining, but I haven’t written Euler for a long time, so after I finished I find it is a semi-implicit one. P is the grid points array, which is read in as local space. In order to be able to drag and observe the effect in Unity, it is converted to world space and then converted back after calculation.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Semi_Implict</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; P.Length; i++) </span><br><span class="line">    &#123; </span><br><span class="line">        P2[i] = transform.TransformPoint(P[i]); </span><br><span class="line">        V[i] += (P2[i] - P1[i]) / dt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">float</span> idt = dt / iter, d = Mathf.Pow(damping, <span class="number">1f</span> / iter);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; iter; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Constrant</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; C.Length; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> x = C[j].x, y = C[j].y; <span class="built_in">float</span> z = C[j].z;</span><br><span class="line">            Vector3 f = k * (<span class="number">1</span> - z / (P2[x] - P2[y]).magnitude) * (P2[x] - P2[y]);</span><br><span class="line">            F[x] -= f; F[y] += f;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Gravity &amp; Update &amp; Calculate Local Position</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; P.Length; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            V[j] = d * V[j] + idt * F[j];</span><br><span class="line">            <span class="keyword">if</span> (W[j] != <span class="number">0</span>) P2[j] += idt * V[j];</span><br><span class="line">            P1[j] = P2[j]; F[j] = g;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; P.Length; i++) P[i] = transform.InverseTransformPoint(P2[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Implicit-Euler"><a href="#Implicit-Euler" class="headerlink" title="Implicit Euler"></a>Implicit Euler</h3><p>There is nothing much to say, it is just gradient iteration. I tried Chebyshev acceleration but it doesn’t seem to make much difference. It is worth mentioning that in the previous version I wrote, I used a normalize and a magnitute to calculate the gradient. After changing to this version, the performance has improved a lot. Daily doubt the implementation of Unity functions.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Implict</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; P.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        V[i] += ((P2[i] = transform.TransformPoint(P[i])) - P1[i]) / dt;</span><br><span class="line">        <span class="keyword">if</span> (W[i] != <span class="number">0</span>) P[i] = P2[i] += (dt * (V[i] *= damping));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">float</span> invdt2 = <span class="number">1</span> / dt / dt, factor = <span class="number">1</span> / (invdt2 + <span class="number">4</span> * k), rho2 = rho * rho, w = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; iter; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Momentum and Gravity.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; P.Length; j++) G[j] = invdt2 * (P2[j] - P[j]) - g;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Spring Force.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; C.Length; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> x = C[j].x, y = C[j].y; <span class="built_in">float</span> z = C[j].z;</span><br><span class="line">            Vector3 grad = k * (<span class="number">1</span> - z / (P2[x] - P2[y]).magnitude) * (P2[x] - P2[y]);</span><br><span class="line">            G[x] += grad; G[y] -= grad;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>) w = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">1</span>) w = <span class="number">2</span> / (<span class="number">2</span> - rho2);</span><br><span class="line">        <span class="keyword">else</span> w = <span class="number">4</span> / (<span class="number">4</span> - w * rho2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Update P2 by gradient.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; P.Length; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (W[j] == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">            Vector3 old = P2[j];</span><br><span class="line">            P2[j] = w * (P2[j] - factor * G[j]) + (<span class="number">1</span> - w) * P1[j];</span><br><span class="line">            P1[j] = old;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; P.Length; i++) </span><br><span class="line">    &#123; </span><br><span class="line">        V[i] += (P2[i] - P[i]) / dt; </span><br><span class="line">        P[i] = transform.InverseTransformPoint(P2[i]); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PBD"><a href="#PBD" class="headerlink" title="PBD"></a>PBD</h3><p>I won’t go into the formulas and algorithm flow, but the general idea is to first move freely, then impose constraints. For a detailed paper interpretation, you can read this <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/419708582">jeffzzz: Position Based Dynamics Notes</a>. But PBD actually has some problems. The biggest problem is that it is not so physical. The physical properties it displays are only linked to the time step and the number of iterations. But the time step is related to performance, and the number of iterations is related to performance. It is a landmine to give different time steps and iterations to different objects in order to change the physical properties…</p>
<p><img src="https://picx.zhimg.com/80/v2-f1a0758cdaa72daa7836aec27a6ac8df_720w.gif?source=d16d100b" alt="img"></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PBD</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; P.Length; i++) P2[i] = transform.TransformPoint(P[i]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Free Update</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; P.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (W[i] == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        V[i] = damping * V[i] + dt * g;</span><br><span class="line">        P2[i] += dt * V[i] + damping * (P2[i] - P1[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; iter; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Strain Limit</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; C.Length; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> x = C[j].x, y = C[j].y; <span class="built_in">float</span> z = C[j].z;</span><br><span class="line">            Vector3 p = z * (P2[x] - P2[y]).normalized;</span><br><span class="line">            SX[x] += <span class="number">0.5f</span> * (P2[x] + P2[y] + p); SN[x]++; SX[y] += <span class="number">0.5f</span> * (P2[x] + P2[y] - p); SN[y]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; P.Length; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (W[j] == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">            P1[j] = P2[j];</span><br><span class="line">            P2[j] = (<span class="number">0.2f</span> * P2[j] + SX[j]) / (<span class="number">0.2f</span> + SN[j]);</span><br><span class="line">            V[j] += (P2[j] - P1[j]) / dt;</span><br><span class="line">            SX[j] = Vector3.zero; SN[j] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; P.Length; i++) P[i] = transform.InverseTransformPoint(P1[i] = P2[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="XPBD"><a href="#XPBD" class="headerlink" title="XPBD"></a>XPBD</h3><p>XPBD redefines PBD constraints by introducing elastic potential energy, solving the above PBD problem with less than 5% increase in time (the paper seems to say 2-3%, but it’s roughly the same). The recommended paper interpretation here is <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/406652407">zilch: XPBD Paper Interpretation</a>, or you can also take a look at <a target="_blank" rel="noopener" href="https://github.com/matthias-research/pages/blob/master/tenMinutePhysics/14-cloth.html">WebXPBDCloth</a> written by the founder Müller. It will be faster to understand it in combination with actual engineering.</p>
<p><img src="https://picx.zhimg.com/80/v2-fb2d697cbb11746a20b37886ba0fc903_720w.gif?source=d16d100b" alt="img"></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">XPBD</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">float</span> idt = dt / iter, a = <span class="number">1f</span> / k / idt / idt, d = Mathf.Pow(damping, <span class="number">1f</span> / iter);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; P.Length; i++) &#123; V[i] += ((P2[i] = transform.TransformPoint(P[i])) - P1[i]) / idt; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; iter; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Free Update</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; P.Length; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (W[j] == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">            V[j] = d * V[j] + idt * g;</span><br><span class="line">            P2[j] += idt * V[j];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Solve Constraint (Gauss Seidel)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; C.Length; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> x = C[j].x, y = C[j].y; <span class="built_in">float</span> z = C[j].z, w = W[x] + W[y];</span><br><span class="line">            Vector3 grad = -(<span class="number">1</span> - z / (P2[x] - P2[y]).magnitude) * (P2[x] - P2[y]) / (a + w);</span><br><span class="line">            P2[x] += grad * W[x]; P2[y] -= grad * W[y];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Record Velocity</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; P.Length; j++) &#123; V[j] = (P2[j] - P1[j]) / idt; P1[j] = P2[j]; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; P.Length; i++) P[i] = transform.InverseTransformPoint(P2[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://ayinzhang.github.io/en">YiZhen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://ayinzhang.github.io/en/2024/11/25/2024-11-26-Unity%20Physics%20Simulation%20Method%20Environment%20Hodgepodge/">https://ayinzhang.github.io/en/2024/11/25/2024-11-26-Unity%20Physics%20Simulation%20Method%20Environment%20Hodgepodge/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/en/tags/Animated-simulation/">Animated simulation</a><a class="post-meta__tags" href="/en/tags/MultiThread/">MultiThread</a></div><div class="post_share"><div class="social-share" data-image="https://pica.zhimg.com/70/v2-f6bca2be2f713b9248d0def917d533b3_1440w.avis?source=172ae18b&amp;biz_tag=Post" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>Sponsor</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/en/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/en/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/en/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/en/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/en/2024/12/21/2024-12-22-XNode%20Simple%20Visual%20Dialogue%20Editor/" title="XNode Introduction and Visual Dialogue Editor"><img class="cover" src="https://picx.zhimg.com/70/v2-b44e6f5c815f8fcfcc426f0b114edbbd_1440w.avis?source=172ae18b&amp;biz_tag=Post" onerror="onerror=null;src='/en/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">XNode Introduction and Visual Dialogue Editor</div></div></a></div><div class="next-post pull-right"><a href="/en/2024/09/07/2024-9-8-Unity%20Meta%20Game%20Doxing%20Pre-research/" title="C# Meta Game Doxing Pre-research"><img class="cover" src="https://pic1.zhimg.com/v2-ee201568687003742dc85ae7d03f40de.jpeg" onerror="onerror=null;src='/en/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">C# Meta Game Doxing Pre-research</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/en/2022/12/24/2022-12-25-GAMES201/" title="GAMES201"><img class="cover" src="https://picx.zhimg.com/70/v2-323f384f9aa03b42d04343c85cb302fd_1440w.avis?source=172ae18b&biz_tag=Post" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-25</div><div class="title">GAMES201</div></div></a></div><div><a href="/en/2023/03/08/2023-3-9-Dynamic%20Bone%20Simple%20Analysis/" title="Dynamic Bone Simple Analysis"><img class="cover" src="https://picx.zhimg.com/70/v2-4abfce4c3122d36ef9506fb9608c7077_1440w.avis?source=172ae18b&biz_tag=Post" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-09</div><div class="title">Dynamic Bone Simple Analysis</div></div></a></div><div><a href="/en/2025/03/05/2025-3-6-Honkai%20Star%20Rail%20Bartending/" title="Honkai Star Rail Bartending"><img class="cover" src="https://pica.zhimg.com/70/v2-ab5b1cb243e07c5bbd1fdaddbed0a19e_1440w.avis?source=172ae18b&biz_tag=Post" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-06</div><div class="title">Honkai Star Rail Bartending</div></div></a></div><div><a href="/en/2025/02/12/2025-2-13-Water%20Caustics/" title="Unity Water Caustics Rendering and Simulation"><img class="cover" src="https://pic1.zhimg.com/v2-eb779799112e9cf076a749de09ee543f_720w.png?source=d16d100b" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-13</div><div class="title">Unity Water Caustics Rendering and Simulation</div></div></a></div><div><a href="/en/2023/05/19/2023-5-20-Simply%20Exploration%20of%20Unity%20Burst/" title="Simply Exploration of Unity Burst"><img class="cover" src="https://pic1.zhimg.com/70/v2-189c5f8c6c1ff2ce71897c229bea8101_1440w.avis?source=172ae18b&biz_tag=Post" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-20</div><div class="title">Simply Exploration of Unity Burst</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/en/img/me.png" onerror="this.onerror=null;this.src='/en/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">YiZhen</div><div class="author-info__description">End Apocalypse</div></div><div class="card-info-data site-data is-center"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">19</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ayinzhang"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ayinzhang" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1242857339@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">It's just a little wind frost</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Comparison-Overview"><span class="toc-number">1.</span> <span class="toc-text">Comparison Overview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Semi-Implicit-Euler"><span class="toc-number">2.</span> <span class="toc-text">Semi-Implicit Euler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Implicit-Euler"><span class="toc-number">3.</span> <span class="toc-text">Implicit Euler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PBD"><span class="toc-number">4.</span> <span class="toc-text">PBD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XPBD"><span class="toc-number">5.</span> <span class="toc-text">XPBD</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/en/2025/03/05/2025-3-6-Honkai%20Star%20Rail%20Bartending/" title="Honkai Star Rail Bartending"><img src="https://pica.zhimg.com/70/v2-ab5b1cb243e07c5bbd1fdaddbed0a19e_1440w.avis?source=172ae18b&amp;biz_tag=Post" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Honkai Star Rail Bartending"/></a><div class="content"><a class="title" href="/en/2025/03/05/2025-3-6-Honkai%20Star%20Rail%20Bartending/" title="Honkai Star Rail Bartending">Honkai Star Rail Bartending</a><time datetime="2025-03-05T16:00:00.000Z" title="Created 2025-03-06 00:00:00">2025-03-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2025/02/12/2025-2-13-Water%20Caustics/" title="Unity Water Caustics Rendering and Simulation"><img src="https://pic1.zhimg.com/v2-eb779799112e9cf076a749de09ee543f_720w.png?source=d16d100b" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Unity Water Caustics Rendering and Simulation"/></a><div class="content"><a class="title" href="/en/2025/02/12/2025-2-13-Water%20Caustics/" title="Unity Water Caustics Rendering and Simulation">Unity Water Caustics Rendering and Simulation</a><time datetime="2025-02-12T16:00:00.000Z" title="Created 2025-02-13 00:00:00">2025-02-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2024/12/21/2024-12-22-XNode%20Simple%20Visual%20Dialogue%20Editor/" title="XNode Introduction and Visual Dialogue Editor"><img src="https://picx.zhimg.com/70/v2-b44e6f5c815f8fcfcc426f0b114edbbd_1440w.avis?source=172ae18b&amp;biz_tag=Post" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="XNode Introduction and Visual Dialogue Editor"/></a><div class="content"><a class="title" href="/en/2024/12/21/2024-12-22-XNode%20Simple%20Visual%20Dialogue%20Editor/" title="XNode Introduction and Visual Dialogue Editor">XNode Introduction and Visual Dialogue Editor</a><time datetime="2024-12-21T16:00:00.000Z" title="Created 2024-12-22 00:00:00">2024-12-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2024/11/25/2024-11-26-Unity%20Physics%20Simulation%20Method%20Environment%20Hodgepodge/" title="Unity Euler and Position based Simulation Methods together with languages Hodgepodge"><img src="https://pica.zhimg.com/70/v2-f6bca2be2f713b9248d0def917d533b3_1440w.avis?source=172ae18b&amp;biz_tag=Post" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Unity Euler and Position based Simulation Methods together with languages Hodgepodge"/></a><div class="content"><a class="title" href="/en/2024/11/25/2024-11-26-Unity%20Physics%20Simulation%20Method%20Environment%20Hodgepodge/" title="Unity Euler and Position based Simulation Methods together with languages Hodgepodge">Unity Euler and Position based Simulation Methods together with languages Hodgepodge</a><time datetime="2024-11-25T16:00:00.000Z" title="Created 2024-11-26 00:00:00">2024-11-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2024/09/07/2024-9-8-Unity%20Meta%20Game%20Doxing%20Pre-research/" title="C# Meta Game Doxing Pre-research"><img src="https://pic1.zhimg.com/v2-ee201568687003742dc85ae7d03f40de.jpeg" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="C# Meta Game Doxing Pre-research"/></a><div class="content"><a class="title" href="/en/2024/09/07/2024-9-8-Unity%20Meta%20Game%20Doxing%20Pre-research/" title="C# Meta Game Doxing Pre-research">C# Meta Game Doxing Pre-research</a><time datetime="2024-09-07T16:00:00.000Z" title="Created 2024-09-08 00:00:00">2024-09-08</time></div></div></div></div></div></div></main><footer id="footer" style="background: rgba(1,1,1,0)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By YiZhen</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="translateLink" type="button" title="Toggle Between Chinese And English">EN</button><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/en/js/utils.js?v=4.13.0"></script><script src="/en/js/main.js?v=4.13.0"></script><script src="/en/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(()=>{
  const getGiscusTheme = theme => {
    return theme === 'dark' ? 'dark' : 'light'
  }

  const loadGiscus = () => {
    const config = Object.assign({
      src: 'https://giscus.app/client.js',
      'data-repo': 'ayinzhang/ayinzhang.github.io',
      'data-repo-id': 'R_kgDOKl3Dog',
      'data-category-id': 'DIC_kwDOKl3Dos4CaqXe',
      'data-mapping': 'pathname',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true
    },null)

    const ele = document.createElement('script')
    for (let key in config) {
      ele.setAttribute(key, config[key])
    }
    document.getElementById('giscus-wrap').appendChild(ele)
  }

  const changeGiscusTheme = theme => {
    const sendMessage = message => {
      const iframe = document.querySelector('iframe.giscus-frame')
      if (!iframe) return
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
    }

    sendMessage({
      setConfig: {
        theme: getGiscusTheme(theme)
      }
    });
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment= loadGiscus
  }
})()</script></div><script data-pjax src="/en/self/btf.js"></script><script data-pjax src="/en/self/tw_en.js"></script><div class="aplayer no-destroy" data-id="8985244058" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false"> </div><script id="canvas_nest" defer="defer" color="0,0,0" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="true" data-text="且行且看,尽力而为,不要害怕,不要后悔" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/en/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/en/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/en/live2dw/assets/elica.model.json"},"display":{"superSample":2,"width":200,"height":400,"position":"right","hOffset":20,"vOffset":-130},"mobile":{"show":false,"scale":0.3},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false});</script></body></html>