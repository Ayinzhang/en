<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Dynamic Bone Simple Analysis | Ayin</title><meta name="author" content="YiZhen"><meta name="copyright" content="YiZhen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Classic forward kinematics simulation algorithm">
<meta property="og:type" content="article">
<meta property="og:title" content="Dynamic Bone Simple Analysis">
<meta property="og:url" content="https://ayinzhang.github.io/en/2023/03/08/2023-3-9-Dynamic%20Bone%20Simple%20Analysis/index.html">
<meta property="og:site_name" content="Ayin">
<meta property="og:description" content="Classic forward kinematics simulation algorithm">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://picx.zhimg.com/70/v2-4abfce4c3122d36ef9506fb9608c7077_1440w.avis?source=172ae18b&biz_tag=Post">
<meta property="article:published_time" content="2023-03-08T16:00:00.000Z">
<meta property="article:modified_time" content="2024-06-25T07:58:06.345Z">
<meta property="article:author" content="YiZhen">
<meta property="article:tag" content="Physical simulation">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://picx.zhimg.com/70/v2-4abfce4c3122d36ef9506fb9608c7077_1440w.avis?source=172ae18b&biz_tag=Post"><link rel="shortcut icon" href="https://fastly.jsdelivr.net/gh/ayinzhang/ayinzhang.github.io/img/icon.png"><link rel="canonical" href="https://ayinzhang.github.io/en/2023/03/08/2023-3-9-Dynamic%20Bone%20Simple%20Analysis/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/en/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f74029fa7cc77ea7995800ef7950497d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/en/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"EN","msgToSimplifiedChinese":"ZH"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Dynamic Bone Simple Analysis',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-25 15:58:06'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/en/img/me.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">15</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">6</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/en/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/en/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/en/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="https://ayinzhang.github.io/"><i class="fa-fw fas fa-c"></i><span> Language</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://picx.zhimg.com/70/v2-4abfce4c3122d36ef9506fb9608c7077_1440w.avis?source=172ae18b&amp;biz_tag=Post')"><nav id="nav"><span id="blog-info"><a href="/en/" title="Ayin"><span class="site-name">Ayin</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/en/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/en/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/en/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="https://ayinzhang.github.io/"><i class="fa-fw fas fa-c"></i><span> Language</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Dynamic Bone Simple Analysis</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-03-08T16:00:00.000Z" title="Created 2023-03-09 00:00:00">2023-03-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-06-25T07:58:06.345Z" title="Updated 2024-06-25 15:58:06">2024-06-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/en/categories/Technology-sharing/">Technology sharing</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/en/categories/Technology-sharing/Unity-related/">Unity related</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Dynamic Bone Simple Analysis"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="Written-before"><a href="#Written-before" class="headerlink" title="Written before"></a>Written before</h3><p>&emsp;&emsp;Recently, I received an internship from a company and requested to integrate Dynamic Bone. Although the distance between nodes in Dynamic Bone is constant, the effect of Magica Cloth in fabric simulation is much better than that of Dynamic Bone (but also in terms of performance consumption), the algorithm of Dynamic Bone is also considered classic and worth writing about.</p>
<h3 id="Maintext"><a href="#Maintext" class="headerlink" title="Maintext"></a>Maintext</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> Transform m_Root = <span class="literal">null</span>;<span class="comment">//Cutting reference</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Transform&gt; m_Roots = <span class="literal">null</span>;<span class="comment">//Cutting distance</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> m_UpdateRate = <span class="number">60.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> UpdateMode</span><br><span class="line">    &#123;</span><br><span class="line">        Normal,</span><br><span class="line">        AnimatePhysics,</span><br><span class="line">        UnscaledTime,</span><br><span class="line">        Default</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> UpdateMode m_UpdateMode = UpdateMode.Default;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Range(0, 1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> m_Damping = <span class="number">0.1f</span>;</span><br><span class="line">    <span class="keyword">public</span> AnimationCurve m_DampingDistrib = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Range(0, 1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> m_Elasticity = <span class="number">0.1f</span>;</span><br><span class="line">    <span class="keyword">public</span> AnimationCurve m_ElasticityDistrib = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Range(0, 1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> m_Stiffness = <span class="number">0.1f</span>;</span><br><span class="line">    <span class="keyword">public</span> AnimationCurve m_StiffnessDistrib = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Range(0, 1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> m_Inert = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> AnimationCurve m_InertDistrib = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> m_Friction = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> AnimationCurve m_FrictionDistrib = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> m_Radius = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> AnimationCurve m_RadiusDistrib = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> m_EndLength = <span class="number">0</span>;<span class="comment">//Virtual tail node length</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector3 m_EndOffset = Vector3.zero;<span class="comment">//Virtual tail node bias</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector3 m_Gravity = Vector3.zero;<span class="comment">//Gravity</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector3 m_Force = Vector3.zero;<span class="comment">//External force</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">Range(0, 1)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> m_BlendWeight = <span class="number">1.0f</span>;<span class="comment">//Blend Weight</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;DynamicBoneColliderBase&gt; m_Colliders = <span class="literal">null</span>;<span class="comment">//Collision itemset</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Transform&gt; m_Exclusions = <span class="literal">null</span>;<span class="comment">//Exclusion itemset</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> FreezeAxis<span class="comment">//Locked Axis</span></span><br><span class="line">    &#123;</span><br><span class="line">        None, X, Y, Z</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> FreezeAxis m_FreezeAxis = FreezeAxis.None;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> m_DistantDisable = <span class="literal">false</span>;<span class="comment">//Cutting by distance or not</span></span><br><span class="line">    <span class="keyword">public</span> Transform m_ReferenceObject = <span class="literal">null</span>;<span class="comment">//Reference object</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> m_DistanceToObject = <span class="number">20</span>;<span class="comment">//Reference distance</span></span><br><span class="line"></span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> m_Multithread = <span class="literal">true</span>;<span class="comment">//Use multithread or not</span></span><br><span class="line"></span><br><span class="line">    Vector3 m_ObjectMove;<span class="comment">//Move direction</span></span><br><span class="line">    Vector3 m_ObjectPrevPosition;<span class="comment">//Position of last frame </span></span><br><span class="line">    <span class="built_in">float</span> m_ObjectScale;<span class="comment">//Global scale</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">float</span> m_Time = <span class="number">0</span>;<span class="comment">//Timer</span></span><br><span class="line">    <span class="built_in">float</span> m_Weight = <span class="number">1.0f</span>;<span class="comment">//Bone weight</span></span><br><span class="line">    <span class="built_in">bool</span> m_DistantDisabled = <span class="literal">false</span>;<span class="comment">//Cutting by distance or not</span></span><br><span class="line">    <span class="built_in">int</span> m_PreUpdateCount = <span class="number">0</span>;<span class="comment">//Multithread counter</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Particle</span><span class="comment">//Bone nodes</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> Transform m_Transform;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> m_ParentIndex;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> m_ChildCount;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> m_Damping;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> m_Elasticity;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> m_Stiffness;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> m_Inert;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> m_Friction;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> m_Radius;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> m_BoneLength;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> m_isCollide;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> m_TransformNotNull;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Vector3 m_Position;</span><br><span class="line">        <span class="keyword">public</span> Vector3 m_PrevPosition;</span><br><span class="line">        <span class="keyword">public</span> Vector3 m_EndOffset;</span><br><span class="line">        <span class="keyword">public</span> Vector3 m_InitLocalPosition;</span><br><span class="line">        <span class="keyword">public</span> Quaternion m_InitLocalRotation;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Prepared data</span></span><br><span class="line">        <span class="keyword">public</span> Vector3 m_TransformPosition;</span><br><span class="line">        <span class="keyword">public</span> Vector3 m_TransformLocalPosition;</span><br><span class="line">        <span class="keyword">public</span> Matrix4x4 m_TransformLocalToWorldMatrix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">ParticleTree</span><span class="comment">//Single bone</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> Transform m_Root;</span><br><span class="line">        <span class="keyword">public</span> Vector3 m_LocalGravity;</span><br><span class="line">        <span class="keyword">public</span> Matrix4x4 m_RootWorldToLocalMatrix;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> m_BoneTotalLength;</span><br><span class="line">        <span class="keyword">public</span> List&lt;Particle&gt; m_Particles = <span class="keyword">new</span> List&lt;Particle&gt;();<span class="comment">//Node list</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Prepared data</span></span><br><span class="line">        <span class="keyword">public</span> Vector3 m_RestGravity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;ParticleTree&gt; m_ParticleTrees = <span class="keyword">new</span> List&lt;ParticleTree&gt;();<span class="comment">//Bone tree</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Prepared data</span></span><br><span class="line">    <span class="built_in">float</span> m_DeltaTime;<span class="comment">//Classical Î”t</span></span><br><span class="line">    List&lt;DynamicBoneColliderBase&gt; m_EffectiveColliders;<span class="comment">//Collider list</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_MULTITHREAD</span></span><br><span class="line">    <span class="built_in">bool</span> m_WorkAdded = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">static</span> List&lt;DynamicBone&gt; s_PendingWorks = <span class="keyword">new</span> List&lt;DynamicBone&gt;();</span><br><span class="line">    <span class="keyword">static</span> List&lt;DynamicBone&gt; s_EffectiveWorks = <span class="keyword">new</span> List&lt;DynamicBone&gt;();</span><br><span class="line">    <span class="keyword">static</span> AutoResetEvent s_AllWorksDoneEvent;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">int</span> s_RemainWorkCount;</span><br><span class="line">    <span class="keyword">static</span> Semaphore s_WorkQueueSemaphore;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">int</span> s_WorkQueueIndex;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">int</span> s_UpdateCount;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">int</span> s_PrepareFrame;</span><br></pre></td></tr></table></figure>

<h4 id="Start"><a href="#Start" class="headerlink" title="Start()"></a>Start()</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    SetupParticles();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="SetupParticles"><a href="#SetupParticles" class="headerlink" title="SetupParticles()"></a>SetupParticles()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetupParticles</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    m_ParticleTrees.Clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_Root != <span class="literal">null</span>)<span class="comment">//The previous version only had m_Roots but not m_Roots, which is compatible here</span></span><br><span class="line">    &#123;</span><br><span class="line">        AppendParticleTree(m_Root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_Roots != <span class="literal">null</span>)<span class="comment">//Join the root nodes in sequence in m-Roots</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_Roots.Count; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            Transform root = m_Roots[i];</span><br><span class="line">            <span class="keyword">if</span> (root == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (m_ParticleTrees.Exists(x =&gt; x.m_Root == root))<span class="comment">//Use lambda to remove duplicates of m_Roots in m_Roots</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            AppendParticleTree(root);<span class="comment">//Add nodes</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_ObjectScale = Mathf.Abs(transform.lossyScale.x);<span class="comment">//Global scale</span></span><br><span class="line">    m_ObjectPrevPosition = transform.position;<span class="comment">//Initialize previous position</span></span><br><span class="line">    m_ObjectMove = Vector3.zero;<span class="comment">//Initialize move direction</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_ParticleTrees.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        ParticleTree pt = m_ParticleTrees[i];</span><br><span class="line">        AppendParticles(pt, pt.m_Root, <span class="number">-1</span>, <span class="number">0</span>);<span class="comment">//Add child nodes&#x27; information</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UpdateParameters();<span class="comment">//Update nodes</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="AppendParticleTree"><a href="#AppendParticleTree" class="headerlink" title="AppendParticleTree()"></a>AppendParticleTree()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AppendParticleTree</span>(<span class="params">Transform root</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> pt = <span class="keyword">new</span> ParticleTree();</span><br><span class="line">    pt.m_Root = root;</span><br><span class="line">    pt.m_RootWorldToLocalMatrix = root.worldToLocalMatrix;</span><br><span class="line">    m_ParticleTrees.Add(pt);<span class="comment">//Add each bone root node to the bone tree</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AppendParticles</span>(<span class="params">ParticleTree pt, Transform b, <span class="built_in">int</span> parentIndex, <span class="built_in">float</span> boneLength</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> p = <span class="keyword">new</span> Particle();</span><br><span class="line">    p.m_Transform = b;</span><br><span class="line">    p.m_TransformNotNull = b != <span class="literal">null</span>;</span><br><span class="line">    p.m_ParentIndex = parentIndex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (b != <span class="literal">null</span>)<span class="comment">//Initialize normal nodes</span></span><br><span class="line">    &#123;</span><br><span class="line">        p.m_Position = p.m_PrevPosition = b.position;</span><br><span class="line">        p.m_InitLocalPosition = b.localPosition;</span><br><span class="line">        p.m_InitLocalRotation = b.localRotation;<span class="comment">//Save local position</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span><span class="comment">//Create virtual tail node</span></span><br><span class="line">    &#123;</span><br><span class="line">        Transform pb = pt.m_Particles[parentIndex].m_Transform;</span><br><span class="line">        <span class="keyword">if</span> (m_EndLength &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Transform ppb = pb.parent;</span><br><span class="line">            <span class="keyword">if</span> (ppb != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                p.m_EndOffset = pb.InverseTransformPoint((pb.position * <span class="number">2</span> - ppb.position)) * m_EndLength;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                p.m_EndOffset = <span class="keyword">new</span> Vector3(m_EndLength, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            p.m_EndOffset=pb.InverseTransformPoint(transform.TransformDirection(m_EndOffset)+pb.position);</span><br><span class="line">        &#125;</span><br><span class="line">        p.m_Position = p.m_PrevPosition = pb.TransformPoint(p.m_EndOffset);</span><br><span class="line">        p.m_InitLocalPosition = Vector3.zero;</span><br><span class="line">        p.m_InitLocalRotation = Quaternion.identity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parentIndex &gt;= <span class="number">0</span>)<span class="comment">//Calculation of bone length and number of child nodes in non root nodes</span></span><br><span class="line">    &#123;</span><br><span class="line">        boneLength += (pt.m_Particles[parentIndex].m_Transform.position - p.m_Position).magnitude;</span><br><span class="line">        p.m_BoneLength = boneLength;</span><br><span class="line">        pt.m_BoneTotalLength = Mathf.Max(pt.m_BoneTotalLength, boneLength);</span><br><span class="line">        ++pt.m_Particles[parentIndex].m_ChildCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> index = pt.m_Particles.Count;</span><br><span class="line">    pt.m_Particles.Add(p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (b != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; b.childCount; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            Transform child = b.GetChild(i);</span><br><span class="line">            <span class="built_in">bool</span> exclude = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (m_Exclusions != <span class="literal">null</span>)<span class="comment">//Traverse to exclude nodes</span></span><br><span class="line">            &#123;</span><br><span class="line">                exclude = m_Exclusions.Contains(child);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!exclude)<span class="comment">//No exclusion, recursively adding nodes</span></span><br><span class="line">            &#123;</span><br><span class="line">                AppendParticles(pt, child, index, boneLength);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (m_EndLength &gt; <span class="number">0</span> || m_EndOffset != Vector3.zero)<span class="comment">//Excluded, generate virtual tail nodes</span></span><br><span class="line">            &#123;</span><br><span class="line">                AppendParticles(pt, <span class="literal">null</span>, index, boneLength);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (b.childCount == <span class="number">0</span> &amp;&amp; (m_EndLength &gt; <span class="number">0</span> || m_EndOffset != Vector3.zero))<span class="comment">//Generate virtual tail nodes</span></span><br><span class="line">        &#123;</span><br><span class="line">            AppendParticles(pt, <span class="literal">null</span>, index, boneLength);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UpdateParameters"><a href="#UpdateParameters" class="headerlink" title="UpdateParameters()"></a>UpdateParameters()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateParameters</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    SetWeight(m_BlendWeight);<span class="comment">//Set animation physics blending parameters to subsequently affect node stiffness</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_ParticleTrees.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        UpdateParameters(m_ParticleTrees[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateParameters</span>(<span class="params">ParticleTree pt</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Calculate local gravity direction</span></span><br><span class="line">    pt.m_LocalGravity=pt.m_RootWorldToLocalMatrix.MultiplyVector(m_Gravity).normalized*m_Gravity.magnitude;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; pt.m_Particles.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        Particle p = pt.m_Particles[i];</span><br><span class="line">        p.m_Damping = m_Damping;</span><br><span class="line">        p.m_Elasticity = m_Elasticity;</span><br><span class="line">        p.m_Stiffness = m_Stiffness;</span><br><span class="line">        p.m_Inert = m_Inert;</span><br><span class="line">        p.m_Friction = m_Friction;</span><br><span class="line">        p.m_Radius = m_Radius;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pt.m_BoneTotalLength &gt; <span class="number">0</span>)<span class="comment">//Assign values based on the proportion of animation curves and bone length</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> a = p.m_BoneLength / pt.m_BoneTotalLength;</span><br><span class="line">            <span class="keyword">if</span> (m_DampingDistrib != <span class="literal">null</span> &amp;&amp; m_DampingDistrib.keys.Length &gt; <span class="number">0</span>)</span><br><span class="line">                p.m_Damping *= m_DampingDistrib.Evaluate(a);</span><br><span class="line">            <span class="keyword">if</span> (m_ElasticityDistrib != <span class="literal">null</span> &amp;&amp; m_ElasticityDistrib.keys.Length &gt; <span class="number">0</span>)</span><br><span class="line">                p.m_Elasticity *= m_ElasticityDistrib.Evaluate(a);</span><br><span class="line">            <span class="keyword">if</span> (m_StiffnessDistrib != <span class="literal">null</span> &amp;&amp; m_StiffnessDistrib.keys.Length &gt; <span class="number">0</span>)</span><br><span class="line">                p.m_Stiffness *= m_StiffnessDistrib.Evaluate(a);</span><br><span class="line">            <span class="keyword">if</span> (m_InertDistrib != <span class="literal">null</span> &amp;&amp; m_InertDistrib.keys.Length &gt; <span class="number">0</span>)</span><br><span class="line">                p.m_Inert *= m_InertDistrib.Evaluate(a);</span><br><span class="line">            <span class="keyword">if</span> (m_FrictionDistrib != <span class="literal">null</span> &amp;&amp; m_FrictionDistrib.keys.Length &gt; <span class="number">0</span>)</span><br><span class="line">                p.m_Friction *= m_FrictionDistrib.Evaluate(a);</span><br><span class="line">            <span class="keyword">if</span> (m_RadiusDistrib != <span class="literal">null</span> &amp;&amp; m_RadiusDistrib.keys.Length &gt; <span class="number">0</span>)</span><br><span class="line">                p.m_Radius *= m_RadiusDistrib.Evaluate(a);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Make parameters conform to physics</span></span><br><span class="line">        p.m_Damping = Mathf.Clamp01(p.m_Damping);</span><br><span class="line">        p.m_Elasticity = Mathf.Clamp01(p.m_Elasticity);</span><br><span class="line">        p.m_Stiffness = Mathf.Clamp01(p.m_Stiffness);</span><br><span class="line">        p.m_Inert = Mathf.Clamp01(p.m_Inert);</span><br><span class="line">        p.m_Friction = Mathf.Clamp01(p.m_Friction);</span><br><span class="line">        p.m_Radius = Mathf.Max(p.m_Radius, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Update"><a href="#Update" class="headerlink" title="Update()"></a>Update()</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_UpdateMode != UpdateMode.AnimatePhysics)</span><br><span class="line">        &#123;</span><br><span class="line">            PreUpdate();<span class="comment">//Initialize local spatial information of bones</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_MULTITHREAD //If multithreading is enabled</span></span><br><span class="line">        <span class="keyword">if</span> (m_PreUpdateCount &gt; <span class="number">0</span> &amp;&amp; m_Multithread) <span class="comment">//Requires multithreaded updates</span></span><br><span class="line">        &#123;</span><br><span class="line">            AddPendingWork(<span class="keyword">this</span>);</span><br><span class="line">            m_WorkAdded = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        ++s_UpdateCount;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="PreUpdate"><a href="#PreUpdate" class="headerlink" title="PreUpdate()"></a>PreUpdate()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PreUpdate</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (IsNeedUpdate())</span><br><span class="line">    &#123;</span><br><span class="line">        InitTransforms();<span class="comment">//Reset bone coordinate information</span></span><br><span class="line">    &#125;</span><br><span class="line">    ++m_PreUpdateCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="InitTransforms"><a href="#InitTransforms" class="headerlink" title="InitTransforms()"></a>InitTransforms()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InitTransforms</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_ParticleTrees.Count; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            InitTransforms(m_ParticleTrees[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InitTransforms</span>(<span class="params">ParticleTree pt</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; pt.m_Particles.Count; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            Particle p = pt.m_Particles[i];</span><br><span class="line">            <span class="keyword">if</span> (p.m_TransformNotNull)<span class="comment">//Change local coordinates to initial values</span></span><br><span class="line">            &#123;</span><br><span class="line">                p.m_Transform.localPosition = p.m_InitLocalPosition;</span><br><span class="line">                p.m_Transform.localRotation = p.m_InitLocalRotation;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="AddPendingWork"><a href="#AddPendingWork" class="headerlink" title="AddPendingWork()"></a>AddPendingWork()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddPendingWork</span>(<span class="params">DynamicBone db</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        s_PendingWorks.Add(db); <span class="comment">//Add bones to the waiting queue</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="LateUpdate"><a href="#LateUpdate" class="headerlink" title="LateUpdate()"></a>LateUpdate()</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LateUpdate</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_PreUpdateCount == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (s_UpdateCount &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            s_UpdateCount = <span class="number">0</span>;</span><br><span class="line">            ++s_PrepareFrame;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SetWeight(m_BlendWeight);<span class="comment">//Set mixed weights for animation and physics</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_MULTITHREAD</span></span><br><span class="line">        <span class="keyword">if</span> (m_WorkAdded) <span class="comment">//If bones were added to the multi-threaded queue before</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_WorkAdded = <span class="literal">false</span>;<span class="comment">//Set back to its original state</span></span><br><span class="line">            ExecuteWorks();<span class="comment">//Execute multithreading</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#123;</span><br><span class="line">            CheckDistance();<span class="comment">//Distance judgment</span></span><br><span class="line">            <span class="keyword">if</span> (IsNeedUpdate())<span class="comment">//Need physical calculations or not</span></span><br><span class="line">            &#123;</span><br><span class="line">                Prepare();<span class="comment">//Processing of data prepared in data structures</span></span><br><span class="line">                UpdateParticles();<span class="comment">//Physical simulation of bones</span></span><br><span class="line">                ApplyParticlesToTransforms();<span class="comment">//Applied Physics Simulation Results</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        m_PreUpdateCount = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="SetWeight"><a href="#SetWeight" class="headerlink" title="SetWeight()"></a>SetWeight()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetWeight</span>(<span class="params"><span class="built_in">float</span> w</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_Weight != w)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (w == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            InitTransforms();<span class="comment">//Reset bone coordinate information</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (m_Weight == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ResetParticlesPosition();<span class="comment">//Reset current position coordinates</span></span><br><span class="line">        &#125;</span><br><span class="line">        m_Weight = m_BlendWeight = w;<span class="comment">//M_Weight is an interface left over from previous versions, only for access here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ResetParticlesPosition"><a href="#ResetParticlesPosition" class="headerlink" title="ResetParticlesPosition()"></a>ResetParticlesPosition()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ResetParticlesPosition</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_ParticleTrees.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        ResetParticlesPosition(m_ParticleTrees[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_ObjectPrevPosition = transform.position;<span class="comment">//Retain previous frame information</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ResetParticlesPosition</span>(<span class="params">ParticleTree pt</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; pt.m_Particles.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        Particle p = pt.m_Particles[i];</span><br><span class="line">        <span class="keyword">if</span> (p.m_TransformNotNull)<span class="comment">//Set both the current position and the previous frame position to Trans values</span></span><br><span class="line">        &#123;</span><br><span class="line">            p.m_Position = p.m_PrevPosition = p.m_Transform.position;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">//Virtual tail node processing</span></span><br><span class="line">        &#123;</span><br><span class="line">            Transform pb = pt.m_Particles[p.m_ParentIndex].m_Transform;</span><br><span class="line">            p.m_Position = p.m_PrevPosition = pb.TransformPoint(p.m_EndOffset);</span><br><span class="line">        &#125;</span><br><span class="line">        p.m_isCollide = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="CheckDistance"><a href="#CheckDistance" class="headerlink" title="CheckDistance()"></a>CheckDistance()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CheckDistance</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!m_DistantDisable)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    Transform rt = m_ReferenceObject;</span><br><span class="line">    <span class="keyword">if</span> (rt == <span class="literal">null</span> &amp;&amp; Camera.main != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        rt = Camera.main.transform;<span class="comment">//Set as camera Trans if there is no reference</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rt != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> d2 = (rt.position - transform.position).sqrMagnitude;</span><br><span class="line">        <span class="built_in">bool</span> disable = d2 &gt; m_DistanceToObject * m_DistanceToObject;<span class="comment">//Is it beyond the distance</span></span><br><span class="line">        <span class="keyword">if</span> (disable != m_DistantDisabled)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!disable)</span><br><span class="line">            &#123;</span><br><span class="line">                ResetParticlesPosition();<span class="comment">//Reset current position coordinates</span></span><br><span class="line">            &#125;</span><br><span class="line">            m_DistantDisabled = disable;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="IsNeedUpdate"><a href="#IsNeedUpdate" class="headerlink" title="IsNeedUpdate()"></a>IsNeedUpdate()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">bool</span> <span class="title">IsNeedUpdate</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> m_Weight &gt; <span class="number">0</span> &amp;&amp; !(m_DistantDisable &amp;&amp; m_DistantDisabled);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare()"></a>Prepare()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Prepare</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        m_DeltaTime = Time.deltaTime;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_5_3_OR_NEWER</span></span><br><span class="line">        <span class="keyword">if</span> (m_UpdateMode == UpdateMode.UnscaledTime)</span><br><span class="line">        &#123;</span><br><span class="line">            m_DeltaTime = Time.unscaledDeltaTime;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (m_UpdateMode == UpdateMode.AnimatePhysics)</span><br><span class="line">        &#123;</span><br><span class="line">            m_DeltaTime = Time.fixedDeltaTime * m_PreUpdateCount;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        m_ObjectScale = Mathf.Abs(transform.lossyScale.x);</span><br><span class="line">        m_ObjectMove = transform.position - m_ObjectPrevPosition;<span class="comment">//Displacement</span></span><br><span class="line">        m_ObjectPrevPosition = transform.position;<span class="comment">//Previous frame position</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_ParticleTrees.Count; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            ParticleTree pt = m_ParticleTrees[i];</span><br><span class="line">            pt.m_RestGravity = pt.m_Root.TransformDirection(pt.m_LocalGravity);<span class="comment">//Gravity changes from local coordinates to world coordinates</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; pt.m_Particles.Count; ++j)</span><br><span class="line">            &#123;</span><br><span class="line">                Particle p = pt.m_Particles[j];</span><br><span class="line">                <span class="keyword">if</span> (p.m_TransformNotNull)<span class="comment">//Record relevant data</span></span><br><span class="line">                &#123;</span><br><span class="line">                    p.m_TransformPosition = p.m_Transform.position;</span><br><span class="line">                    p.m_TransformLocalPosition = p.m_Transform.localPosition;</span><br><span class="line">                    p.m_TransformLocalToWorldMatrix = p.m_Transform.localToWorldMatrix;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_EffectiveColliders != <span class="literal">null</span>)<span class="comment">//Destroy collision list</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_EffectiveColliders.Clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (m_Colliders != <span class="literal">null</span>)<span class="comment">//Create a new collision list</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_Colliders.Count; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                DynamicBoneColliderBase c = m_Colliders[i];</span><br><span class="line">                <span class="keyword">if</span> (c != <span class="literal">null</span> &amp;&amp; c.enabled)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (m_EffectiveColliders == <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_EffectiveColliders = <span class="keyword">new</span> List&lt;DynamicBoneColliderBase&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    m_EffectiveColliders.Add(c);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (c.PrepareFrame != s_PrepareFrame)<span class="comment">//Initialize collision only once</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        c.Prepare();</span><br><span class="line">                        c.PrepareFrame = s_PrepareFrame;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="UpdateParticles"><a href="#UpdateParticles" class="headerlink" title="UpdateParticles()"></a>UpdateParticles()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateParticles</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_ParticleTrees.Count &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> loop = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">float</span> timeVar = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">float</span> dt = m_DeltaTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_UpdateMode == UpdateMode.Default)<span class="comment">//Frame rate processing</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_UpdateRate &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            timeVar = dt * m_UpdateRate;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_UpdateRate &gt; <span class="number">0</span>)<span class="comment">//Control of simulation time steps</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> frameTime = <span class="number">1.0f</span> / m_UpdateRate;</span><br><span class="line">            m_Time += dt;</span><br><span class="line">            loop = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (m_Time &gt;= frameTime)</span><br><span class="line">            &#123;</span><br><span class="line">                m_Time -= frameTime;</span><br><span class="line">                <span class="keyword">if</span> (++loop &gt;= <span class="number">3</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_Time = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (loop &gt; <span class="number">0</span>)<span class="comment">//Simulate iterations</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; loop; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            UpdateParticles1(timeVar, i);<span class="comment">//Inertia and force</span></span><br><span class="line">            UpdateParticles2(timeVar);<span class="comment">//Elasticity and stiffness</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        SkipUpdateParticles();<span class="comment">//Skip simulation</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UpdateParticles1"><a href="#UpdateParticles1" class="headerlink" title="UpdateParticles1()"></a>UpdateParticles1()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateParticles1</span>(<span class="params"><span class="built_in">float</span> timeVar, <span class="built_in">int</span> loopIndex</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_ParticleTrees.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        UpdateParticles1(m_ParticleTrees[i], timeVar, loopIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateParticles1</span>(<span class="params">ParticleTree pt, <span class="built_in">float</span> timeVar, <span class="built_in">int</span> loopIndex</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Vector3 force = m_Gravity;<span class="comment">//Gravity</span></span><br><span class="line">    Vector3 fdir = m_Gravity.normalized;<span class="comment">//Gravity unit vector</span></span><br><span class="line">    Vector3 pf = fdir * Mathf.Max(Vector3.Dot(pt.m_RestGravity, fdir), <span class="number">0</span>);<span class="comment">//Projected gravity</span></span><br><span class="line">    force -= pf;<span class="comment">//Removing the influence of gravity</span></span><br><span class="line">    force = (force + m_Force) * (m_ObjectScale * timeVar);<span class="comment">//Apply time and scale</span></span><br><span class="line"></span><br><span class="line">    Vector3 objectMove = loopIndex == <span class="number">0</span> ? m_ObjectMove : Vector3.zero;<span class="comment">//Only the first loop changes objectMove</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; pt.m_Particles.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        Particle p = pt.m_Particles[i];</span><br><span class="line">        <span class="keyword">if</span> (p.m_ParentIndex &gt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Verlet integration</span></span><br><span class="line">            Vector3 v = p.m_Position - p.m_PrevPosition;<span class="comment">//Node motion direction</span></span><br><span class="line">            Vector3 rmove = objectMove * p.m_Inert;<span class="comment">//Predicting displacement</span></span><br><span class="line">            p.m_PrevPosition = p.m_Position + rmove;<span class="comment">//Predicting position</span></span><br><span class="line">            <span class="built_in">float</span> damping = p.m_Damping;</span><br><span class="line">            <span class="keyword">if</span> (p.m_isCollide)<span class="comment">//If collision occurs</span></span><br><span class="line">            &#123;</span><br><span class="line">                damping += p.m_Friction;<span class="comment">//Friction acts on damping</span></span><br><span class="line">                <span class="keyword">if</span> (damping &gt; <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    damping = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                p.m_isCollide = <span class="literal">false</span>;<span class="comment">//Reset collision detection</span></span><br><span class="line">            &#125;</span><br><span class="line">            p.m_Position += v * (<span class="number">1</span> - damping) + force + rmove;<span class="comment">//Calculate the position of nodes after calculating inertia and external forces</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            p.m_PrevPosition = p.m_Position;</span><br><span class="line">            p.m_Position = p.m_TransformPosition;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UpdateParticles2"><a href="#UpdateParticles2" class="headerlink" title="UpdateParticles2()"></a>UpdateParticles2()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateParticles2</span>(<span class="params"><span class="built_in">float</span> timeVar</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_ParticleTrees.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        UpdateParticles2(m_ParticleTrees[i], timeVar);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UpdateParticles2</span>(<span class="params">ParticleTree pt, <span class="built_in">float</span> timeVar</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> movePlane = <span class="keyword">new</span> Plane();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">1</span>; i &lt; pt.m_Particles.Count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        Particle p = pt.m_Particles[i];<span class="comment">//Node</span></span><br><span class="line">        Particle p0 = pt.m_Particles[p.m_ParentIndex];<span class="comment">//Parent node</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">float</span> restLen;<span class="comment">//Length between parent node and child node</span></span><br><span class="line">        <span class="keyword">if</span> (p.m_TransformNotNull)<span class="comment">//Normal node</span></span><br><span class="line">        &#123;</span><br><span class="line">            restLen = (p0.m_TransformPosition - p.m_TransformPosition).magnitude;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//Virtual tail node</span></span><br><span class="line">        &#123;</span><br><span class="line">            restLen = p0.m_TransformLocalToWorldMatrix.MultiplyVector(p.m_EndOffset).magnitude;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Keep shape</span></span><br><span class="line">        <span class="built_in">float</span> stiffness = Mathf.Lerp(<span class="number">1.0f</span>, p.m_Stiffness, m_Weight);</span><br><span class="line">        <span class="keyword">if</span> (stiffness &gt; <span class="number">0</span> || p.m_Elasticity &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Matrix4x4 m0 = p0.m_TransformLocalToWorldMatrix;<span class="comment">//Matrix from local coordinates of parent node to world coordinates</span></span><br><span class="line">            m0.SetColumn(<span class="number">3</span>, p0.m_Position);<span class="comment">//m0 is the matrix from the local coordinates of the node to the world coordinates</span></span><br><span class="line">            Vector3 restPos;<span class="comment">//Regression coordinates</span></span><br><span class="line">            <span class="keyword">if</span> (p.m_TransformNotNull)</span><br><span class="line">            &#123;</span><br><span class="line">                restPos = m0.MultiplyPoint3x4(p.m_TransformLocalPosition);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                restPos = m0.MultiplyPoint3x4(p.m_EndOffset);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Vector3 d = restPos - p.m_Position;<span class="comment">//Regression vector</span></span><br><span class="line">            p.m_Position += d * (p.m_Elasticity * timeVar);<span class="comment">//Apply elasticity</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (stiffness &gt; <span class="number">0</span>)<span class="comment">//Rigid motion</span></span><br><span class="line">            &#123;</span><br><span class="line">                d = restPos - p.m_Position;</span><br><span class="line">                <span class="built_in">float</span> len = d.magnitude;</span><br><span class="line">                <span class="built_in">float</span> maxlen = restLen * (<span class="number">1</span> - stiffness) * <span class="number">2</span>;<span class="comment">//Calculate theoretical length</span></span><br><span class="line">                <span class="keyword">if</span> (len &gt; maxlen)</span><br><span class="line">                &#123;</span><br><span class="line">                    p.m_Position += d * ((len - maxlen) / len);<span class="comment">//Coordinate offset</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Collision</span></span><br><span class="line">        <span class="keyword">if</span> (m_EffectiveColliders != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> particleRadius = p.m_Radius * m_ObjectScale;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; m_EffectiveColliders.Count; ++j)</span><br><span class="line">            &#123;</span><br><span class="line">                DynamicBoneColliderBase c = m_EffectiveColliders[j];</span><br><span class="line">                p.m_isCollide |= c.Collide(<span class="keyword">ref</span> p.m_Position, particleRadius);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Handle locked axis</span></span><br><span class="line">        <span class="keyword">if</span> (m_FreezeAxis != FreezeAxis.None)</span><br><span class="line">        &#123;</span><br><span class="line">            Vector3 planeNormal=p0.m_TransformLocalToWorldMatrix.GetColumn((<span class="built_in">int</span>)m_FreezeAxis<span class="number">-1</span>).normalized;</span><br><span class="line">            movePlane.SetNormalAndPosition(planeNormal, p0.m_Position);</span><br><span class="line">            p.m_Position -= movePlane.normal * movePlane.GetDistanceToPoint(p.m_Position);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Keep length</span></span><br><span class="line">        Vector3 dd = p0.m_Position - p.m_Position;<span class="comment">//The bone direction after updating child nodes</span></span><br><span class="line">        <span class="built_in">float</span> leng = dd.magnitude;<span class="comment">//The bone length after updating child nodes</span></span><br><span class="line">        <span class="keyword">if</span> (leng &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            p.m_Position += dd * ((leng - restLen) / leng);<span class="comment">//Update coordinates to ensure consistent bone length</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ApplyParticlesToTransforms"><a href="#ApplyParticlesToTransforms" class="headerlink" title="ApplyParticlesToTransforms()"></a>ApplyParticlesToTransforms()</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ApplyParticlesToTransforms</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        Vector3 ax = Vector3.right;</span><br><span class="line">        Vector3 ay = Vector3.up;</span><br><span class="line">        Vector3 az = Vector3.forward;</span><br><span class="line">        <span class="built_in">bool</span> nx = <span class="literal">false</span>, ny = <span class="literal">false</span>, nz = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !UNITY_5_4_OR_NEWER</span></span><br><span class="line">        Vector3 lossyScale = transform.lossyScale;</span><br><span class="line">        <span class="keyword">if</span> (lossyScale.x &lt; <span class="number">0</span> || lossyScale.y &lt; <span class="number">0</span> || lossyScale.z &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Transform mirrorObject = transform;</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                Vector3 ls = mirrorObject.localScale;</span><br><span class="line">                nx = ls.x &lt; <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (nx)</span><br><span class="line">                    ax = mirrorObject.right;</span><br><span class="line">                ny = ls.y &lt; <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (ny)</span><br><span class="line">                    ay = mirrorObject.up;</span><br><span class="line">                nz = ls.z &lt; <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (nz)</span><br><span class="line">                    az = mirrorObject.forward;</span><br><span class="line">                <span class="keyword">if</span> (nx || ny || nz)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                mirrorObject = mirrorObject.parent;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (mirrorObject != <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; m_ParticleTrees.Count; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            ApplyParticlesToTransforms(m_ParticleTrees[i], ax, ay, az, nx, ny, nz);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ApplyParticlesToTransforms</span>(<span class="params">ParticleTree pt,Vector3 ax,Vector3 ay,Vector3 az,<span class="built_in">bool</span> nx,<span class="built_in">bool</span> ny,<span class="built_in">bool</span> nz</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">1</span>; i &lt; pt.m_Particles.Count; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            Particle p = pt.m_Particles[i];</span><br><span class="line">            Particle p0 = pt.m_Particles[p.m_ParentIndex];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (p0.m_ChildCount &lt;= <span class="number">1</span>)<span class="comment">//Modify bone orientation when only a single child node is present</span></span><br><span class="line">            &#123;</span><br><span class="line">                Vector3 localPos;</span><br><span class="line">                <span class="keyword">if</span> (p.m_TransformNotNull)<span class="comment">//Normal node</span></span><br><span class="line">                &#123;</span><br><span class="line">                    localPos = p.m_Transform.localPosition;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span><span class="comment">//Virtual tail node</span></span><br><span class="line">                &#123;</span><br><span class="line">                    localPos = p.m_EndOffset;</span><br><span class="line">                &#125;</span><br><span class="line">                Vector3 v0 = p0.m_Transform.TransformDirection(localPos);</span><br><span class="line">                Vector3 v1 = p.m_Position - p0.m_Position;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !UNITY_5_4_OR_NEWER</span></span><br><span class="line">                <span class="keyword">if</span> (nx)</span><br><span class="line">                    v1 = MirrorVector(v1, ax);</span><br><span class="line">                <span class="keyword">if</span> (ny)</span><br><span class="line">                    v1 = MirrorVector(v1, ay);</span><br><span class="line">                <span class="keyword">if</span> (nz)</span><br><span class="line">                    v1 = MirrorVector(v1, az);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                Quaternion rot = Quaternion.FromToRotation(v0, v1);</span><br><span class="line">                p0.m_Transform.rotation = rot * p0.m_Transform.rotation;<span class="comment">//Handle parent node rotation</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (p.m_TransformNotNull)<span class="comment">//Nomal child node</span></span><br><span class="line">            &#123;</span><br><span class="line">                p.m_Transform.position = p.m_Position;<span class="comment">//Apply simulation result</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>&emsp;&emsp;The plugin was last updated to version 1.3.2 more than a year ago, so it should have been in development now. There are already many (but not new) articles analyzing Dynamic bone, so I am committed to presenting the entire basic flow function of the script (other flow functions that are not shown also call the sub functions mentioned earlier). I hope it can be helpful to readers.</p>
<p>&emsp;&emsp;Overall, the chain structure of the skeleton was first constructed, local coordinates were recorded, and then the application of inertia, friction, external forces, elasticity, and stiffness from root to tail was processed and updated at each level. If you still have doubts, you can also move to other articles on Zhihu. Detailed explanation of the core code: <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/522873426">Dynamic Bone source code analysis</a> Explanation of Simulation Algorithm: <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/49188230">Detailed Explanation of Dynamic Bone Algorithm for Dynamic Bones</a>.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://ayinzhang.github.io/en">YiZhen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://ayinzhang.github.io/en/2023/03/08/2023-3-9-Dynamic%20Bone%20Simple%20Analysis/">https://ayinzhang.github.io/en/2023/03/08/2023-3-9-Dynamic%20Bone%20Simple%20Analysis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/en/tags/Physical-simulation/">Physical simulation</a></div><div class="post_share"><div class="social-share" data-image="https://picx.zhimg.com/70/v2-4abfce4c3122d36ef9506fb9608c7077_1440w.avis?source=172ae18b&amp;biz_tag=Post" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>Sponsor</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/en/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/en/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/en/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/en/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/en/2023/05/19/2023-5-20-Simply%20Exploration%20of%20Unity%20Burst/" title="Simply Exploration of Unity Burst"><img class="cover" src="https://pic1.zhimg.com/70/v2-189c5f8c6c1ff2ce71897c229bea8101_1440w.avis?source=172ae18b&amp;biz_tag=Post" onerror="onerror=null;src='/en/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">Simply Exploration of Unity Burst</div></div></a></div><div class="next-post pull-right"><a href="/en/2022/12/24/2022-12-25-GAMES201/" title="GAMES201"><img class="cover" src="https://picx.zhimg.com/70/v2-323f384f9aa03b42d04343c85cb302fd_1440w.avis?source=172ae18b&amp;biz_tag=Post" onerror="onerror=null;src='/en/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">GAMES201</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/en/2022/12/24/2022-12-25-GAMES201/" title="GAMES201"><img class="cover" src="https://picx.zhimg.com/70/v2-323f384f9aa03b42d04343c85cb302fd_1440w.avis?source=172ae18b&biz_tag=Post" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-25</div><div class="title">GAMES201</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/en/img/me.png" onerror="this.onerror=null;this.src='/en/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">YiZhen</div><div class="author-info__description">End Apocalypse</div></div><div class="card-info-data site-data is-center"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">15</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">6</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ayinzhang"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ayinzhang" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1242857339@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">It's just a little wind frost</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Written-before"><span class="toc-number">1.</span> <span class="toc-text">Written before</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Maintext"><span class="toc-number">2.</span> <span class="toc-text">Maintext</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Start"><span class="toc-number">2.1.</span> <span class="toc-text">Start()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#SetupParticles"><span class="toc-number">2.1.1.</span> <span class="toc-text">SetupParticles()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AppendParticleTree"><span class="toc-number">2.1.2.</span> <span class="toc-text">AppendParticleTree()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UpdateParameters"><span class="toc-number">2.1.3.</span> <span class="toc-text">UpdateParameters()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Update"><span class="toc-number">2.2.</span> <span class="toc-text">Update()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#PreUpdate"><span class="toc-number">2.2.1.</span> <span class="toc-text">PreUpdate()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#InitTransforms"><span class="toc-number">2.2.2.</span> <span class="toc-text">InitTransforms()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AddPendingWork"><span class="toc-number">2.2.3.</span> <span class="toc-text">AddPendingWork()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LateUpdate"><span class="toc-number">2.3.</span> <span class="toc-text">LateUpdate()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#SetWeight"><span class="toc-number">2.3.1.</span> <span class="toc-text">SetWeight()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ResetParticlesPosition"><span class="toc-number">2.3.2.</span> <span class="toc-text">ResetParticlesPosition()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CheckDistance"><span class="toc-number">2.3.3.</span> <span class="toc-text">CheckDistance()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#IsNeedUpdate"><span class="toc-number">2.3.4.</span> <span class="toc-text">IsNeedUpdate()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Prepare"><span class="toc-number">2.3.5.</span> <span class="toc-text">Prepare()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UpdateParticles"><span class="toc-number">2.3.6.</span> <span class="toc-text">UpdateParticles()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UpdateParticles1"><span class="toc-number">2.3.7.</span> <span class="toc-text">UpdateParticles1()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UpdateParticles2"><span class="toc-number">2.3.8.</span> <span class="toc-text">UpdateParticles2()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ApplyParticlesToTransforms"><span class="toc-number">2.3.9.</span> <span class="toc-text">ApplyParticlesToTransforms()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Conclusion"><span class="toc-number">3.</span> <span class="toc-text">Conclusion</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/en/2024/09/07/2024-9-8-C#%20Meta%20Game%20Doxing%20Pre-research/" title="C# Meta Game Doxing Pre-research"><img src="https://pic1.zhimg.com/v2-ee201568687003742dc85ae7d03f40de.jpeg" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="C# Meta Game Doxing Pre-research"/></a><div class="content"><a class="title" href="/en/2024/09/07/2024-9-8-C#%20Meta%20Game%20Doxing%20Pre-research/" title="C# Meta Game Doxing Pre-research">C# Meta Game Doxing Pre-research</a><time datetime="2024-09-07T16:00:00.000Z" title="Created 2024-09-08 00:00:00">2024-09-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2024/08/14/2024-8-15-Undergraduate%20Program%20Conclusion/" title="Undergraduate Program Conclusion"><img src="https://picx.zhimg.com/70/v2-c953913a2dc6d4c5fc7f5f2bbb698d79_1440w.avis?source=172ae18b&amp;biz_tag=Post" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Undergraduate Program Conclusion"/></a><div class="content"><a class="title" href="/en/2024/08/14/2024-8-15-Undergraduate%20Program%20Conclusion/" title="Undergraduate Program Conclusion">Undergraduate Program Conclusion</a><time datetime="2024-08-14T16:00:00.000Z" title="Created 2024-08-15 00:00:00">2024-08-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2024/06/05/2024-6-6-Paper%20Fantacy/" title="Paper Fantacy"><img src="https://pic1.zhimg.com/70/v2-eb6dc165c10a896cc3dadf64ab37dfc9_1440w.avis?source=172ae18b&amp;biz_tag=Post" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Paper Fantacy"/></a><div class="content"><a class="title" href="/en/2024/06/05/2024-6-6-Paper%20Fantacy/" title="Paper Fantacy">Paper Fantacy</a><time datetime="2024-06-05T16:00:00.000Z" title="Created 2024-06-06 00:00:00">2024-06-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2023/12/18/2023-12-19-Summary%20of%20Unity%20Engine%20Tool%20Internship/" title="Summary of Unity Engine Tool Internship"><img src="https://picx.zhimg.com/70/v2-cb56904f62d22673473a9344025ec21a_1440w.avis?source=172ae18b&amp;biz_tag=Post" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Summary of Unity Engine Tool Internship"/></a><div class="content"><a class="title" href="/en/2023/12/18/2023-12-19-Summary%20of%20Unity%20Engine%20Tool%20Internship/" title="Summary of Unity Engine Tool Internship">Summary of Unity Engine Tool Internship</a><time datetime="2023-12-18T16:00:00.000Z" title="Created 2023-12-19 00:00:00">2023-12-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2023/08/18/2023-8-19-Common%20Numerical%20Integration%20and%20Linear%20System%20Solving%20Methods/" title="Common Numerical Integration and Linear System Solving Methods"><img src="https://pic1.zhimg.com/70/v2-c0b719a5abca82075338d59a53791f30_1440w.avis?source=172ae18b&amp;biz_tag=Post" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Common Numerical Integration and Linear System Solving Methods"/></a><div class="content"><a class="title" href="/en/2023/08/18/2023-8-19-Common%20Numerical%20Integration%20and%20Linear%20System%20Solving%20Methods/" title="Common Numerical Integration and Linear System Solving Methods">Common Numerical Integration and Linear System Solving Methods</a><time datetime="2023-08-18T16:00:00.000Z" title="Created 2023-08-19 00:00:00">2023-08-19</time></div></div></div></div></div></div></main><footer id="footer" style="background: rgba(1,1,1,0)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By YiZhen</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="translateLink" type="button" title="Toggle Between Chinese And English">EN</button><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/en/js/utils.js?v=4.13.0"></script><script src="/en/js/main.js?v=4.13.0"></script><script src="/en/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(()=>{
  const getGiscusTheme = theme => {
    return theme === 'dark' ? 'dark' : 'light'
  }

  const loadGiscus = () => {
    const config = Object.assign({
      src: 'https://giscus.app/client.js',
      'data-repo': 'ayinzhang/ayinzhang.github.io/en',
      'data-repo-id': 'R_kgDOKl3Dog',
      'data-category-id': 'DIC_kwDOKl3Dos4CaqXe',
      'data-mapping': 'pathname',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true
    },null)

    const ele = document.createElement('script')
    for (let key in config) {
      ele.setAttribute(key, config[key])
    }
    document.getElementById('giscus-wrap').appendChild(ele)
  }

  const changeGiscusTheme = theme => {
    const sendMessage = message => {
      const iframe = document.querySelector('iframe.giscus-frame')
      if (!iframe) return
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
    }

    sendMessage({
      setConfig: {
        theme: getGiscusTheme(theme)
      }
    });
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment= loadGiscus
  }
})()</script></div><script data-pjax src="/en/self/btf.js"></script><script data-pjax src="/en/self/tw_en.js"></script><div class="aplayer no-destroy" data-id="8985244058" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false"> </div><script id="canvas_nest" defer="defer" color="0,0,0" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="true" data-text="ä¸”è¡Œä¸”çœ‹,å°½åŠ›è€Œä¸º,ä¸è¦å®³æ€•,ä¸è¦åŽæ‚”" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/en/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/en/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/en/live2dw/assets/elica.model.json"},"display":{"superSample":2,"width":200,"height":400,"position":"right","hOffset":20,"vOffset":-130},"mobile":{"show":false,"scale":0.3},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false});</script></body></html>