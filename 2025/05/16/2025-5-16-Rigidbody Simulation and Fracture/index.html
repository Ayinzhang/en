<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Rigidbody Simulation and Fracture | Ayin</title><meta name="author" content="YiZhen"><meta name="copyright" content="YiZhen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Exploration of rigid body solutions in the gaming industry">
<meta property="og:type" content="article">
<meta property="og:title" content="Rigidbody Simulation and Fracture">
<meta property="og:url" content="https://ayinzhang.github.io/en/2025/05/16/2025-5-16-Rigidbody%20Simulation%20and%20Fracture/index.html">
<meta property="og:site_name" content="Ayin">
<meta property="og:description" content="Exploration of rigid body solutions in the gaming industry">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pic1.zhimg.com/v2-b6a67053dcd8bd0651dcfe15936599e2_720w.png?source=d16d100b">
<meta property="article:published_time" content="2025-05-15T16:00:00.000Z">
<meta property="article:modified_time" content="2025-08-17T14:38:44.427Z">
<meta property="article:author" content="YiZhen">
<meta property="article:tag" content="Animated Simulation">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic1.zhimg.com/v2-b6a67053dcd8bd0651dcfe15936599e2_720w.png?source=d16d100b"><link rel="shortcut icon" href="https://fastly.jsdelivr.net/gh/ayinzhang/ayinzhang.github.io/img/icon.png"><link rel="canonical" href="https://ayinzhang.github.io/en/2025/05/16/2025-5-16-Rigidbody%20Simulation%20and%20Fracture/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/en/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f74029fa7cc77ea7995800ef7950497d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/en/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"EN","msgToSimplifiedChinese":"ZH"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Rigidbody Simulation and Fracture',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-17 22:38:44'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/en/img/me.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">26</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/en/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/en/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/en/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="https://ayinzhang.github.io/"><i class="fa-fw fas fa-c"></i><span> Language</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic1.zhimg.com/v2-b6a67053dcd8bd0651dcfe15936599e2_720w.png?source=d16d100b')"><nav id="nav"><span id="blog-info"><a href="/en/" title="Ayin"><span class="site-name">Ayin</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/en/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/en/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/en/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="https://ayinzhang.github.io/"><i class="fa-fw fas fa-c"></i><span> Language</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Rigidbody Simulation and Fracture</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-05-15T16:00:00.000Z" title="Created 2025-05-16 00:00:00">2025-05-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-08-17T14:38:44.427Z" title="Updated 2025-08-17 22:38:44">2025-08-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/en/categories/Technology-Sharing/">Technology Sharing</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/en/categories/Technology-Sharing/Graphics-Related/">Graphics Related</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Rigidbody Simulation and Fracture"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="Written-before"><a href="#Written-before" class="headerlink" title="Written before"></a>Written before</h3><p>I finished GAMES103 a few years ago and went through the commonly used rigid bodies, cloths, soft bodies, and fluids in graphics. I was able to get started with physical simulation in graphics, but what about after that? I have to explore the road ahead by myself. I personally prefer the game industry that pursues real-time computing and visual reality (after all, I feel that the current academic community is obsessed with various optimization methods or splicing several methods to write water papers), so I plan to re-examine these basic simulation objects to see if I can go further.</p>
<h3 id="Rigidbody-simulation"><a href="#Rigidbody-simulation" class="headerlink" title="Rigidbody simulation"></a>Rigidbody simulation</h3><h4 id="Impulse"><a href="#Impulse" class="headerlink" title="Impulse"></a>Impulse</h4><p>First, let’s warm up a bit by rigid body simulation. For rigid bodies, all game engines generally use linear angular velocity updates and impulses to handle collisions (stability, momentum conservation). The general process is shown in the figure below, and I don’t think I need to elaborate on it.</p>
<p><img src="https://pic1.zhimg.com/80/v2-e501a59db56563cad4c41ea34c9cfb4d_720w.png?source=d16d100b" alt="img"></p>
<h4 id="Shape-matching"><a href="#Shape-matching" class="headerlink" title="Shape matching"></a>Shape matching</h4><p>In comparison, shape matching is rarely used in game engines. Its advantage should be in physics engines (Flex) where different types of objects interact (rigid body, cloth, soft body, mixed fluid). However, considering that the PBD series also follows this idea (free update first, then constrained projection), Just try it out as a rehabilitation exercise. The general idea of shape matching is to first update each vertex freely, and then minimize the mean square error to return it to its original shape (constrained projection).</p>
<img src="https://pica.zhimg.com/80/v2-94ae3dee4597e4e0aeafc5488bd3bc0d_720w.png?source=d16d100b" alt="img" style="zoom:130%;" />

<p>In the algorithm flow, the shape matching part is worth mentioning. First, from the current state of the object, we can get the covariance matrix $S&#x3D;∑(y_i−c)⋅r_i^T$, and then obtain the optimal transformation matrix $A$ by inverse calculation of the covariance matrix and the pre-calculated reference shape covariance matrix ($Q&#x3D; ∑r_i⋅r _i^T $). Finally, the optimal transformation matrix $A$ is decomposed by SVD according to $A&#x3D;U\sum{V}^T$, and the optimal rotation matrix $R&#x3D;UV^T$ is obtained by removing scaling and shearing on the basis of $A$.</p>
<p><img src="https://pic1.zhimg.com/80/v2-8a07413a5f2c449f3c57a8fb59f88458_720w.png?source=d16d100b" alt="img"></p>
<h3 id="Rigidbody-fracture"><a href="#Rigidbody-fracture" class="headerlink" title="Rigidbody fracture"></a>Rigidbody fracture</h3><h4 id="Industry-solutions"><a href="#Industry-solutions" class="headerlink" title="Industry solutions"></a>Industry solutions</h4><p>Generally speaking, rigid body simulation is not very difficult. If you want to go deeper, you can try rigid body fracture. The application scenario is probably mainly FPS games where destroying terrain can bring greater strategic value. Before starting, let’s collect relevant technical sharing and mature plug-ins to see what the industry is doing now. In the technical sharing, I found <a target="_blank" rel="noopener" href="https://archive.org/details/GDC2015Gustafsson">GDC2015 Smash Hit’s slice cutting method</a>, <a target="_blank" rel="noopener" href="https://www.gdcvault.com/play/1023003/The-Art-of-Destruction-in">GDC2016 Rainbow6’s fixed pattern destruction method</a>, <a target="_blank" rel="noopener" href="https://www.gdcvault.com/play/1034790/Visual-Effects-Summit-Fracture-Animation">GDC2024 TheFinals’ pre-segmentation impulse threshold separation method</a>, and <a target="_blank" rel="noopener" href="https://gdcvault.com/play/1035357/Dynamic-Destruction-in-UE5-with">GDC2025 Epic’s pre-segmentation overlap area separation method</a>. As for mature plug-ins, I found OpenFracture and RayFire for Unity. As for UE, Chaos already includes them natively, which saves a lot of effort.</p>
<h5 id="GDC2015-Smash-Hit-slice-cutting"><a href="#GDC2015-Smash-Hit-slice-cutting" class="headerlink" title="GDC2015 Smash Hit slice cutting"></a>GDC2015 Smash Hit slice cutting</h5><p>Smash Hit is a childhood memory for me. Gustafsson’s game design concept for physical playgrounds is popular with me. Sprinkle, Smash Hit, and Teardown are also really cool. For the fracture of Smash Hit, he used a bilateral data structure to explicitly maintain the topological relationship between vertices, edges, and faces; dynamic boundary volume tree plus GJK algorithm for collision detection; and cutting based on vertex side, edge intersection, and closed geometry.</p>
<img src="https://picx.zhimg.com/80/v2-628e2da472622f9dcf9d18ffcbaa71ee_720w.png?source=d16d100b" alt="img" style="zoom:130%;" />

<h5 id="GDC2016-Rainbow6-fixed-pattern-destruction"><a href="#GDC2016-Rainbow6-fixed-pattern-destruction" class="headerlink" title="GDC2016 Rainbow6 fixed pattern destruction"></a>GDC2016 Rainbow6 fixed pattern destruction</h5><p>In Rainbow Six, Ubisoft Montreal used RealBlast for procedural destruction. Typical objects are broken down into leaf structures for easier destruction.</p>
<img src="https://picx.zhimg.com/80/v2-4312928a1b4530b89dd8742658f29fb1_720w.png?source=d16d100b" alt="img" style="zoom:160%;" />

<p>While walls and other surfaces are first projected into two dimensions, then a specific shape is generated based on the input and material parameters, and finally polygon cutting and triangulation are performed.</p>
<img src="https://pic1.zhimg.com/80/v2-012149b2977bf54bf9a91fb07c05755e_720w.jpeg?source=d16d100b" alt="img" style="zoom:120%;" />

<p>PS: The second half of the sharing is all about network synchronization and optimization. If you are interested, you can check it out.</p>
<h5 id="GDC2024-TheFinals-impulse-threshold-separation-GDC2025-Epic-overlap-area-separation"><a href="#GDC2024-TheFinals-impulse-threshold-separation-GDC2025-Epic-overlap-area-separation" class="headerlink" title="GDC2024 TheFinals impulse threshold separation &amp; GDC2025 Epic overlap area separation"></a>GDC2024 TheFinals impulse threshold separation &amp; GDC2025 Epic overlap area separation</h5><p>These two are put together because they both start from pre-segmented meshes, but in terms of separation logic, the former uses impulse thresholds, while the latter uses overlapped areas (one from stress and one from strain, quite symmetrical, plus I haven’t found a diagram that can well describe the relevant methods). To expand a little, the former uses Niagara’s Mesh Renderer and custom UV sets, adds animation inside the material, and then achieves dynamic fragmentation by setting impulse thresholds; the latter uses strain evaluation and anchoring to achieve dynamic fragmentation by comparing the overlap between the collision shape and the pre-segmented map.</p>
<h5 id="Unity-plugins-and-UE-Chaos"><a href="#Unity-plugins-and-UE-Chaos" class="headerlink" title="Unity plugins and UE Chaos"></a>Unity plugins and UE Chaos</h5><p>(Detected same frame, automatically merged) In general, the two engines basically only have random face cutting for real-time cutting, while the pre-processing options are much richer, but most of the principles are still Voronoi diagrams. The general concept is to generate a set of points, and then assign a certain area to each point through a series of operations such as triangulation. UE’s uniform fragmentation, cluster fragmentation, and radiation fragmentation are all based on Voronoi diagrams, but the logic of generating points is different.</p>
<img src="https://picx.zhimg.com/80/v2-fc5b235cfff5ba0e4f7f57164949551a_720w.png?source=d16d100b" alt="img" style="zoom:150%;" />

<h4 id="Custom-simulation"><a href="#Custom-simulation" class="headerlink" title="Custom simulation"></a>Custom simulation</h4><p>After looking at the solutions in the industry, it’s time to come up with some solutions of my own. I personally like the real-time cutting and fracture effect of Smash Hit, but looking at all the methods, except for this and the wall solution of Rainbow Six RealBlast, the other cutting is random&#x2F;preset and has nothing to do with collision information. Rainbow Six’s “generating a specific shape from input and material parameters” step directly discourages me, so I’ll start with the relevant methods of Smash Hit.</p>
<h5 id="Data-structure"><a href="#Data-structure" class="headerlink" title="Data structure"></a>Data structure</h5><p>The bilateral data structure used by Gustafsson explicitly maintains the topological relationship between vertices, edges, and triagles. Points are easy to understand, and edges and triagles are because each cut will open new points on the edge and cut new surface. The bilateral structure is still a bit complicated. Maybe Gustafsson cuts based on vclosed geometry, so this is needed. However, if the cutting logic is triangulation and used vertex deduplication, the stored mesh structure will be relatively simple.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> MeshVertex&#123; float3 position, normal; float2 uv; &#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title">MeshEdge</span>&#123; <span class="built_in">int</span> v1, v2, t1, t2, t1Edge; &#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title">MeshData</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;MeshVertex&gt; vertices, cutVertices;</span><br><span class="line">    List&lt;<span class="built_in">int</span>&gt;[] triangles; <span class="keyword">public</span> List&lt;MeshEdge&gt; constraints;</span><br><span class="line">    <span class="built_in">int</span>[] indexMap; <span class="built_in">int</span> vertexCount, triangleCount</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Fracture-method"><a href="#Fracture-method" class="headerlink" title="Fracture method"></a>Fracture method</h5><p>As mentioned in the previous data structure, the project uses triangulation to simplify cutting. The general process is as follows:</p>
<ol>
<li><p>Vertex side division: divide the vertices into two groups above the cutting plane (topSlice) and below (bottomSlice).</p>
</li>
<li><p>Edge intersection calculation: for the cut edges, interpolate and calculate the intersection, generate the cutting surface vertices and add them to the cutting surface point set (cutVertices).</p>
</li>
<li><p>Triangulation: triangulation point set (cutVertices) and constraint edges (constraints).</p>
</li>
<li><p>Vertex deduplication: merge duplicate cutting surface vertices (WeldCutFaceVertices) to eliminate redundant vertices.</p>
</li>
</ol>
<p>The most difficult part is triangulation, which is implemented using Delaunay triangulation with bin sorting and point-by-point insertion. The project has hundreds of lines, which is not suitable for posting all of them. Here is a brief introduction to the basic process.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Input: Vertex list, Constrained edge list Output: Triangle index list</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> List&lt;<span class="built_in">int</span>&gt; <span class="title">Triangulate</span>(<span class="params">List&lt;MeshVertex&gt; vertices, List&lt;MeshEdge&gt; constraints, Vector3 normal</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Step 1: Project the 3D vertices onto the 2D plane (based on the normal direction)</span></span><br><span class="line">    List&lt;TriPoint&gt; points = ProjectVerticesTo2D(vertices, normal);</span><br><span class="line">    <span class="comment">// Step 2: Construct the initial super triangle (including all points)</span></span><br><span class="line">    List&lt;Triangle&gt; triangles = CreateSuperTriangle(points);</span><br><span class="line">    <span class="comment">// Step 3: Insert all points and gradually build the Delaunay triangulation mesh</span></span><br><span class="line">    <span class="keyword">foreach</span> (TriPoint p <span class="keyword">in</span> points) InsertPoint(p, <span class="keyword">ref</span> triangles);</span><br><span class="line">    <span class="comment">// Step 4: Insert constraint edges and repair the triangle mesh</span></span><br><span class="line">    <span class="keyword">foreach</span> (MeshEdge edge <span class="keyword">in</span> constraints) InsertConstraint(edge.v1, edge.v2, points, <span class="keyword">ref</span> triangles);</span><br><span class="line">    <span class="comment">// Step 5: Remove invalid triangles associated with the super triangle</span></span><br><span class="line">    RemoveSuperTriangle(triangles, points);</span><br><span class="line">    <span class="comment">// Step 6: Convert to output format (vertex index list)</span></span><br><span class="line">    <span class="keyword">return</span> ConvertToIndexList(triangles);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Handle-collision"><a href="#Handle-collision" class="headerlink" title="Handle collision"></a>Handle collision</h5><p>Finally, it is the collision response part that need some skills and inspirations. Random collision frature just cuts a surface at a random position and angle each time, and the physics depends on the speed distribution afterwards. After some trouble, I came up with three physical approximation tricks, which can be regarded as a bit innovative. The first is that the faster the collision speed, the smaller the fragments, the higher the corresponding impact strength, and the more thorough the material crushing. The second is that the closer the collision point is to the edge, the easier it is to half-cut, corresponding to the local cracking of the edge brittle fracture. The third is to cut the surface inward at a random angle, corresponding to the simulated stress inward rupture along the maximum shear direction.</p>
<p>The general approach is to first determine whether it is a full cut or a half cut based on the distance from the collision point to the center and the edge, then project the mesh vertices to the plane perpendicular to the collision speed, construct the initial cut line with the collision projection point and the random angle, then find the point farthest from the line from all mesh projection points, and move the initial cut line to this point according to the cutting ratio. Then apply the inward angle to complete the cutting line information in the world space (to handle the scaling of the object) to obtain the cutting surface. It is not that complicated to describe, but I still encountered many pitfalls in practice (for example, the initial rough cutting was to scale the axisymmetric rectangle into a square and then cut two points on the edge of the unit inscribed circle according to the area ratio, and the fine cutting used the two-dimensional convex hull to calculate the area ratio. Also, I was misled by the Unity function for a long time when dealing with inclination. The solution was obtained by recalling left-multiplying the normal by the transposed inverse matrix during rendering). I don’t know if I can use it to cope with master’s thesis.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Asynchronous process in the main code</span></span><br><span class="line"><span class="function">IEnumerator <span class="title">FractureAsync</span>(<span class="params">Collision collision</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    point = collision.GetContact(<span class="number">0</span>).point; normal = collision.relativeVelocity.normalized;</span><br><span class="line">    <span class="comment">// Cutting ratio, to avoid extreme effects, take 0.5 with a fluctuation of 0.2</span></span><br><span class="line">    sliceRate = <span class="number">0.5f</span> + <span class="number">0.2f</span> * (math.clamp((collision.relativeVelocity.magnitude - collisionVel.x) / (collisionVel.y - collisionVel.x), <span class="number">0</span>, <span class="number">1</span>) - <span class="number">0.5f</span>);</span><br><span class="line">    <span class="keyword">while</span> (fractureCount-- &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        MeshProjector.GetSlice(meshData, transform, point, normal, sliceRate, sliceTilt,</span><br><span class="line">            <span class="keyword">out</span> <span class="keyword">var</span> sliceNormal, <span class="keyword">out</span> <span class="keyword">var</span> sliceOrigin, <span class="keyword">out</span> <span class="keyword">var</span> isFullSlice);</span><br><span class="line">        MeshSlicer.Slice(meshData, sliceNormal, sliceOrigin, <span class="keyword">out</span> <span class="keyword">var</span> topData, <span class="keyword">out</span> <span class="keyword">var</span> bottomData);</span><br><span class="line">        meshes.Add(bottomData.ToMesh());</span><br><span class="line">        topMass = remainMass * (isFullSlice ? <span class="number">1</span> - sliceRate : sliceRate);</span><br><span class="line">        bottomMass += remainMass - topMass; remainMass = topMass;</span><br><span class="line">        <span class="keyword">if</span> (isFullSlice) CreatFragment(bottomMass); meshData = topData; <span class="comment">// Full cut directly generates fragments, half cut retains</span></span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (meshes.Count &gt; <span class="number">0</span>) CreatFragment(bottomMass); gameObject.SetActive(<span class="literal">false</span>); <span class="comment">// Generate one first to avoid the situation where only one fragment is left after all half cut</span></span><br><span class="line">    remainData = meshData; meshes.Add(remainData.ToMesh()); CreatFragment(remainMass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Result-showcase"><a href="#Result-showcase" class="headerlink" title="Result showcase"></a>Result showcase</h5><p>Here, I demonstrate the situation where the ball hits the middle and edge of the glass to show the full cut and half cut. The scene is very rough and is only for technical demonstration. It is the deepest attempt in my personal technology. I may try to include it in my portfolio after I imitate a Smash Hit scene.</p>
<p><img src="https://pica.zhimg.com/80/v2-d2421bf78422aa585a9afdd5ae8ed436_720w.gif?source=d16d100b" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-84ad8e6a839d5f24dc5387cc07953782_720w.gif?source=d16d100b" alt="img"></p>
<p>Update: Slightly improved when imitating the Smash Hit, optimized the handling of continuous collisions</p>
<p><img src="https://picx.zhimg.com/80/v2-7b1b1d5132dadb5f7d310f4bcdb4353f_720w.gif" alt="img"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://ayinzhang.github.io/en">YiZhen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://ayinzhang.github.io/en/2025/05/16/2025-5-16-Rigidbody%20Simulation%20and%20Fracture/">https://ayinzhang.github.io/en/2025/05/16/2025-5-16-Rigidbody%20Simulation%20and%20Fracture/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/en/tags/Animated-Simulation/">Animated Simulation</a></div><div class="post_share"><div class="social-share" data-image="https://pic1.zhimg.com/v2-b6a67053dcd8bd0651dcfe15936599e2_720w.png?source=d16d100b" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>Sponsor</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/en/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/en/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/en/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/en/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/en/2025/08/16/2025-8-16-Simply%20Exploration%20of%20Unity%20YooAsset%20+%20HybridCLR%20Hot%20Update/" title="Simply Exploration of Unity YooAsset + HybridCLR Hot Update"><img class="cover" src="https://pic1.zhimg.com/v2-09bfa8f60abc5361104c7584f6df43cd_720w.jpeg?source=d16d100b" onerror="onerror=null;src='/en/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">Simply Exploration of Unity YooAsset + HybridCLR Hot Update</div></div></a></div><div class="next-post pull-right"><a href="/en/2025/05/10/2025-5-10-ICEY/" title="ICEY"><img class="cover" src="https://pic1.zhimg.com/80/v2-61c4e8dc421ca9ea137777d60867148c_720w.png" onerror="onerror=null;src='/en/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">ICEY</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/en/2022/12/25/2022-12-25-GAMES201/" title="GAMES201"><img class="cover" src="https://picx.zhimg.com/70/v2-323f384f9aa03b42d04343c85cb302fd_1440w.avis?source=172ae18b&biz_tag=Post" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-25</div><div class="title">GAMES201</div></div></a></div><div><a href="/en/2024/11/26/2024-11-26-Unity%20Physics%20Simulation%20Method%20Environment%20Hodgepodge/" title="Unity Euler and Position based Simulation Methods together with languages Hodgepodge"><img class="cover" src="https://pica.zhimg.com/70/v2-f6bca2be2f713b9248d0def917d533b3_1440w.avis?source=172ae18b&biz_tag=Post" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-26</div><div class="title">Unity Euler and Position based Simulation Methods together with languages Hodgepodge</div></div></a></div><div><a href="/en/2023/03/09/2023-3-9-Dynamic%20Bone%20Simple%20Analysis/" title="Dynamic Bone Simple Analysis"><img class="cover" src="https://picx.zhimg.com/70/v2-4abfce4c3122d36ef9506fb9608c7077_1440w.avis?source=172ae18b&biz_tag=Post" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-09</div><div class="title">Dynamic Bone Simple Analysis</div></div></a></div><div><a href="/en/2025/02/13/2025-2-13-Water%20Caustics/" title="Water Caustics Rendering and Simulation"><img class="cover" src="https://pic1.zhimg.com/v2-eb779799112e9cf076a749de09ee543f_720w.png?source=d16d100b" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-13</div><div class="title">Water Caustics Rendering and Simulation</div></div></a></div><div><a href="/en/2025/03/06/2025-3-6-Honkai%20Star%20Rail%20Bartending/" title="Honkai Star Rail Bartending"><img class="cover" src="https://pica.zhimg.com/70/v2-ab5b1cb243e07c5bbd1fdaddbed0a19e_1440w.avis?source=172ae18b&biz_tag=Post" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-06</div><div class="title">Honkai Star Rail Bartending</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/en/img/me.jpg" onerror="this.onerror=null;this.src='/en/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">YiZhen</div><div class="author-info__description">End Apocalypse</div></div><div class="card-info-data site-data is-center"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">26</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ayinzhang"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ayinzhang" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1242857339@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">It's just a little wind frost</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Written-before"><span class="toc-number">1.</span> <span class="toc-text">Written before</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rigidbody-simulation"><span class="toc-number">2.</span> <span class="toc-text">Rigidbody simulation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Impulse"><span class="toc-number">2.1.</span> <span class="toc-text">Impulse</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Shape-matching"><span class="toc-number">2.2.</span> <span class="toc-text">Shape matching</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rigidbody-fracture"><span class="toc-number">3.</span> <span class="toc-text">Rigidbody fracture</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Industry-solutions"><span class="toc-number">3.1.</span> <span class="toc-text">Industry solutions</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#GDC2015-Smash-Hit-slice-cutting"><span class="toc-number">3.1.1.</span> <span class="toc-text">GDC2015 Smash Hit slice cutting</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GDC2016-Rainbow6-fixed-pattern-destruction"><span class="toc-number">3.1.2.</span> <span class="toc-text">GDC2016 Rainbow6 fixed pattern destruction</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GDC2024-TheFinals-impulse-threshold-separation-GDC2025-Epic-overlap-area-separation"><span class="toc-number">3.1.3.</span> <span class="toc-text">GDC2024 TheFinals impulse threshold separation &amp; GDC2025 Epic overlap area separation</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Unity-plugins-and-UE-Chaos"><span class="toc-number">3.1.4.</span> <span class="toc-text">Unity plugins and UE Chaos</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Custom-simulation"><span class="toc-number">3.2.</span> <span class="toc-text">Custom simulation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Data-structure"><span class="toc-number">3.2.1.</span> <span class="toc-text">Data structure</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Fracture-method"><span class="toc-number">3.2.2.</span> <span class="toc-text">Fracture method</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Handle-collision"><span class="toc-number">3.2.3.</span> <span class="toc-text">Handle collision</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Result-showcase"><span class="toc-number">3.2.4.</span> <span class="toc-text">Result showcase</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/en/2026/01/17/2026-1-17-Godot%20Jolt%20Parallel%20Comparison/" title="Godot vs Jolt Parallel Comparison"><img src="https://picx.zhimg.com/v2-d28e53e000188ec10622ace95af2cfcb_1440w.png?source=ccfced1a" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Godot vs Jolt Parallel Comparison"/></a><div class="content"><a class="title" href="/en/2026/01/17/2026-1-17-Godot%20Jolt%20Parallel%20Comparison/" title="Godot vs Jolt Parallel Comparison">Godot vs Jolt Parallel Comparison</a><time datetime="2026-01-16T16:00:00.000Z" title="Created 2026-01-17 00:00:00">2026-01-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2026/01/15/2026-1-15-Analysis%20of%20Godot%20Physics%20Source%20Code/" title="Analysis of Godot Physics Source Code"><img src="https://picx.zhimg.com/v2-a58a4e744580865dce7d671dfb7ebbb3_1440w.png?source=ccfced1a" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Analysis of Godot Physics Source Code"/></a><div class="content"><a class="title" href="/en/2026/01/15/2026-1-15-Analysis%20of%20Godot%20Physics%20Source%20Code/" title="Analysis of Godot Physics Source Code">Analysis of Godot Physics Source Code</a><time datetime="2026-01-14T16:00:00.000Z" title="Created 2026-01-15 00:00:00">2026-01-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2026/01/07/2026-1-7-Simply%20Exploration%20of%20Unity%20ML-Agents%20Reinforcement%20Learning/" title="Simply Exploration of Unity ML-Agents Reinforcement Learning"><img src="https://picx.zhimg.com/v2-42d063eae19380631578c7a1af6acddd_1440w.png?source=ccfced1a" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Simply Exploration of Unity ML-Agents Reinforcement Learning"/></a><div class="content"><a class="title" href="/en/2026/01/07/2026-1-7-Simply%20Exploration%20of%20Unity%20ML-Agents%20Reinforcement%20Learning/" title="Simply Exploration of Unity ML-Agents Reinforcement Learning">Simply Exploration of Unity ML-Agents Reinforcement Learning</a><time datetime="2026-01-06T16:00:00.000Z" title="Created 2026-01-07 00:00:00">2026-01-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2025/12/19/2025-12-19-Simply%20Exploration%20of%20LLM%20PEFT%20Fine-tuning%20and%20Ollama%20Operation/" title="Simply Exploration of LLM PEFT Fine-tuning and Ollama Operation"><img src="https://pic1.zhimg.com/v2-71b0fc16e8b2f0e3771e38494b646666_r.jpg?source=172ae18b" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Simply Exploration of LLM PEFT Fine-tuning and Ollama Operation"/></a><div class="content"><a class="title" href="/en/2025/12/19/2025-12-19-Simply%20Exploration%20of%20LLM%20PEFT%20Fine-tuning%20and%20Ollama%20Operation/" title="Simply Exploration of LLM PEFT Fine-tuning and Ollama Operation">Simply Exploration of LLM PEFT Fine-tuning and Ollama Operation</a><time datetime="2025-12-18T16:00:00.000Z" title="Created 2025-12-19 00:00:00">2025-12-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2025/08/16/2025-8-16-Simply%20Exploration%20of%20Unity%20YooAsset%20+%20HybridCLR%20Hot%20Update/" title="Simply Exploration of Unity YooAsset + HybridCLR Hot Update"><img src="https://pic1.zhimg.com/v2-09bfa8f60abc5361104c7584f6df43cd_720w.jpeg?source=d16d100b" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Simply Exploration of Unity YooAsset + HybridCLR Hot Update"/></a><div class="content"><a class="title" href="/en/2025/08/16/2025-8-16-Simply%20Exploration%20of%20Unity%20YooAsset%20+%20HybridCLR%20Hot%20Update/" title="Simply Exploration of Unity YooAsset + HybridCLR Hot Update">Simply Exploration of Unity YooAsset + HybridCLR Hot Update</a><time datetime="2025-08-15T16:00:00.000Z" title="Created 2025-08-16 00:00:00">2025-08-16</time></div></div></div></div></div></div></main><footer id="footer" style="background: rgba(1,1,1,0)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2026 By YiZhen</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="translateLink" type="button" title="Toggle Between Chinese And English">EN</button><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/en/js/utils.js?v=4.13.0"></script><script src="/en/js/main.js?v=4.13.0"></script><script src="/en/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(()=>{
  const getGiscusTheme = theme => {
    return theme === 'dark' ? 'dark' : 'light'
  }

  const loadGiscus = () => {
    const config = Object.assign({
      src: 'https://giscus.app/client.js',
      'data-repo': 'ayinzhang/ayinzhang.github.io',
      'data-repo-id': 'R_kgDOKl3Dog',
      'data-category-id': 'DIC_kwDOKl3Dos4CaqXe',
      'data-mapping': 'pathname',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true
    },null)

    const ele = document.createElement('script')
    for (let key in config) {
      ele.setAttribute(key, config[key])
    }
    document.getElementById('giscus-wrap').appendChild(ele)
  }

  const changeGiscusTheme = theme => {
    const sendMessage = message => {
      const iframe = document.querySelector('iframe.giscus-frame')
      if (!iframe) return
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
    }

    sendMessage({
      setConfig: {
        theme: getGiscusTheme(theme)
      }
    });
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment= loadGiscus
  }
})()</script></div><script data-pjax src="/en/self/btf.js"></script><script data-pjax src="/en/self/tw_en.js"></script><div class="aplayer no-destroy" data-id="8985244058" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false"> </div><script id="canvas_nest" defer="defer" color="0,0,0" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="true" data-text="且行且看,尽力而为,不要害怕,不要后悔" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/en/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/en/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/en/live2dw/assets/elica.model.json"},"display":{"superSample":2,"width":200,"height":400,"position":"right","hOffset":20,"vOffset":-130},"mobile":{"show":false,"scale":0.3},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false});</script></body></html>