<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Honkai Star Rail Bartending | Ayin</title><meta name="author" content="YiZhen"><meta name="copyright" content="YiZhen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="HSR Start! May this journey lead us starward.">
<meta property="og:type" content="article">
<meta property="og:title" content="Honkai Star Rail Bartending">
<meta property="og:url" content="https://ayinzhang.github.io/en/2025/03/05/2025-3-6-Honkai%20Star%20Rail%20Bartending/index.html">
<meta property="og:site_name" content="Ayin">
<meta property="og:description" content="HSR Start! May this journey lead us starward.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pica.zhimg.com/70/v2-ab5b1cb243e07c5bbd1fdaddbed0a19e_1440w.avis?source=172ae18b&biz_tag=Post">
<meta property="article:published_time" content="2025-03-05T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-08T22:23:42.863Z">
<meta property="article:author" content="YiZhen">
<meta property="article:tag" content="Animated simulation">
<meta property="article:tag" content="Graphics Rendering">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pica.zhimg.com/70/v2-ab5b1cb243e07c5bbd1fdaddbed0a19e_1440w.avis?source=172ae18b&biz_tag=Post"><link rel="shortcut icon" href="https://fastly.jsdelivr.net/gh/ayinzhang/ayinzhang.github.io/img/icon.png"><link rel="canonical" href="https://ayinzhang.github.io/en/2025/03/05/2025-3-6-Honkai%20Star%20Rail%20Bartending/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/en/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f74029fa7cc77ea7995800ef7950497d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/en/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"EN","msgToSimplifiedChinese":"ZH"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Honkai Star Rail Bartending',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-09 06:23:42'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/en/img/me.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">21</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/en/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/en/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/en/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="https://ayinzhang.github.io/"><i class="fa-fw fas fa-c"></i><span> Language</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pica.zhimg.com/70/v2-ab5b1cb243e07c5bbd1fdaddbed0a19e_1440w.avis?source=172ae18b&amp;biz_tag=Post')"><nav id="nav"><span id="blog-info"><a href="/en/" title="Ayin"><span class="site-name">Ayin</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/en/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/en/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/en/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/en/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/en/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/en/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="https://ayinzhang.github.io/"><i class="fa-fw fas fa-c"></i><span> Language</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Honkai Star Rail Bartending</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-03-05T16:00:00.000Z" title="Created 2025-03-06 00:00:00">2025-03-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-03-08T22:23:42.863Z" title="Updated 2025-03-09 06:23:42">2025-03-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/en/categories/Technology-sharing/">Technology sharing</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/en/categories/Technology-sharing/Graphics-related/">Graphics related</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Honkai Star Rail Bartending"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="Written-before"><a href="#Written-before" class="headerlink" title="Written before"></a>Written before</h3><p>I am an old player of MiHoYo, and a veteran of Honkai Impact 3rd. Although I gave up playing Honkai Impact 3rd after the first part was finished, the gameplay effect of the bartending in HSR last year was amazing. In addition, MiHoYo announced the <a target="_blank" rel="noopener" href="https://www.patentguru.com/cn/CN119113517A">related technology patent</a> at the end of last year, and in the recent question I answered with ycz, she mentioned the liquid surface simulation of spring particles, which I think deserved to take a try. First of all, I would like to thank Yidi1D for the <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/694949392">Layered Liquid Bottle</a>. My personal direction is mainly the engine tool and physical simulation, not very proficient in rendering. I learned a lot from the article.</p>
<h3 id="Patent-Introduction"><a href="#Patent-Introduction" class="headerlink" title="Patent Introduction"></a>Patent Introduction</h3><p>The patent contains a lot of nonsense, and there are only two points that give some information: the first is the spring skeleton model, which takes the center of mass as the starting point and the liquid surface as the end point, and then constructs the liquid surface equation using the point and normal, and finally constructs the entire virtual liquid surface by intersecting the camera rays; the second is the fusion of the inner wall and the liquid surface normal at the joint to express the surface tension. It is quite disappointing to read it. The title says “liquid simulation method”, but the real simulation only involves a spring, and the rest is all about rendering. I personally feel that it is quite trivial, so I will not reproduce it in a fundamentalist way, and start my own reproduction based on simulation.</p>
<p><img src="https://picx.zhimg.com/80/v2-e175ced2ad897fd5a63876451f5b01f6_720w.png?source=d16d100b" alt="img"></p>
<p><img src="https://pica.zhimg.com/80/v2-267566d96a3b5664dc4885394c190cb9_720w.png?source=d16d100b" alt="img"></p>
<h3 id="Real-time-rendering"><a href="#Real-time-rendering" class="headerlink" title="Real-time rendering"></a>Real-time rendering</h3><p>I found some bartending tool models online, and some of them were borrowed from Yidi1D. I also put a picture of a bartending table as the background, which made it look more similar to the game scene. For the scene rendering, I hand-wrote PBR and customized Phong models to adapt to the model textures. The bartending rendering was based on Yidi1D’s stipple transparency and liquid layering lerp.</p>
<h4 id="Stipple-transparency"><a href="#Stipple-transparency" class="headerlink" title="Stipple transparency"></a>Stipple transparency</h4><p>Stipple transparency is to deal with the rendering order of ice and liquid, which are both transparent. The two should interact with each other, but I was too lazy to change the SRP pipeline, so I gave the ice a 16-level stipple transparency. A more detailed explanation is [here](Unity Stipple Transparency Shader - Alex Ocias Blogocias.com&#x2F;blog&#x2F;unity-stipple-transparency-shader&#x2F;). The general idea is to cut out some pixels with a preset transparency probability. It’s a very old technology. I miss the FC era. Although it was limited by hardware, people at that time were really creative, so the appearance of the animal well was so eye-catching… In the subsequent GIF, you can see that the ice has obvious stripes. The reason is that the pixel cropping is based on the screen space and the multiple windows opened lead to insufficient resolution of the game window. This problem will not occur after full screen.</p>
<h4 id="Liquid-lerp"><a href="#Liquid-lerp" class="headerlink" title="Liquid lerp"></a>Liquid lerp</h4><p>When interpolating the liquid surface layer line, I just use the min and max functions to directly interpolate the upper and lower layer colors. I personally feel that there is no difference in disturbance. Although this may be criticized by the artist, it doesn’t matter because I am not TA (</p>
<p><img src="https://picx.zhimg.com/80/v2-1ef7690368f86f1b3bdaf580e61d6406_720w.png?source=d16d100b" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f = saturate((frac(h) - 0.5 + _BlendFrac) / (2 * _BlendFrac));</span><br><span class="line">int l = max(0, floor(h)), r = min(_LayerCnt - 1, ceil(h));</span><br><span class="line">albedo = lerp(_LayerCols[l], _LayerCols[r], f * (_NoiseSV.x * SAMPLE_TEXTURE2D(_NoiseMap, sampler_NoiseMap, i.uv + _Time.x * _NoiseSV.zw).a + 1 - 0.5 * _NoiseSV.x));</span><br></pre></td></tr></table></figure>

<h3 id="Physics-simulation"><a href="#Physics-simulation" class="headerlink" title="Physics simulation"></a>Physics simulation</h3><p>Then there is the self-creation of the simulation part. Based on my personal experience playing in HSR, I feel that MiHoYo focuses more on rendering than simulation: the patent summarizes that “the spring particle grid is very expensive, so we use a single spring”, “players value visual details, so we have to do normal blending”; and in the new version, the bath of Amphoreus, the splashes are extremely exaggerated and should not be simulated. The water fluctuation SWE or mean diffusion will do. Since it’s all on the computer, why not some physical splash effects to put pressure on the GPU?</p>
<h4 id="Physical-Interaction"><a href="#Physical-Interaction" class="headerlink" title="Physical Interaction"></a>Physical Interaction</h4><p>Back to the topic, for the physical simulation of bartending, I use 4x4 spring particles and 8 iterations. After all, the size of the liquid surface is not large, and the mean diffusion of the pool next door can be used to blur the 64x64 Custom Render Texture (CRT). Initialize the state-pressure constraint (ACM sequelae), and update to use PBD (it’s easy to do after writing so many cloths). I personally feel that the spring particle simulation liquid surface equation is suitable for the situation of solid-liquid coupling interaction, so when adding ice cubes and stirring, it is also abstracted as a particle and a spring particle grid interaction. Finally, the spring particle information is passed to the Shader with ComputeBuffer, and the task on the C# script side comes to an end.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">// Mass-Spring</span><br><span class="line">Vector3[] points; // x: height, y: old_height z: velocity</span><br><span class="line">int[] constrains; // bitmask</span><br><span class="line">Vector4[] datas; // x: height, yzw: normal</span><br><span class="line">ComputeBuffer dataBuffer;</span><br><span class="line"></span><br><span class="line">void BuildConstrains()</span><br><span class="line">&#123;</span><br><span class="line">    for (int i = 0; i &lt; constrains.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        int x = i / gridSize, y = i % gridSize;</span><br><span class="line">        // Build Constrains</span><br><span class="line">        if (x &lt; gridSize - 1)</span><br><span class="line">        &#123;</span><br><span class="line">            constrains[x * gridSize + y] = (constrains[x * gridSize + y] &lt;&lt; 3) + 1;</span><br><span class="line">            constrains[(x + 1) * gridSize + y] = (constrains[(x + 1) * gridSize + y] &lt;&lt; 3) + 2;</span><br><span class="line">        &#125;</span><br><span class="line">        if (y &lt; gridSize - 1)</span><br><span class="line">        &#123;</span><br><span class="line">            constrains[x * gridSize + y] = (constrains[x * gridSize + y] &lt;&lt; 3) + 3;</span><br><span class="line">            constrains[x * gridSize + y + 1] = (constrains[x * gridSize + y + 1] &lt;&lt; 3) + 4;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void HandleCollision(Vector3 pos, float radius)</span><br><span class="line">&#123;</span><br><span class="line">    for (int i = 0; i &lt; points.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        int x = i / gridSize, y = i % gridSize;</span><br><span class="line">        Vector3 pointPos = new Vector3(x / (gridSize - 1f),</span><br><span class="line">            points[i].x, y / (gridSize - 1f));</span><br><span class="line">        float d = (pos - pointPos).magnitude, dx = radius + 1f / (2 * gridSize - 2);</span><br><span class="line">        if (d &lt; dx) continue;</span><br><span class="line">        points[i].x = -Mathf.Sqrt(d * d - dx * dx);</span><br><span class="line">        points[i].z = (points[i].x - points[i].y) / dt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void UpdateMassSpring(bool updateVel = true)</span><br><span class="line">&#123;</span><br><span class="line">    // PBD Iteration</span><br><span class="line">    float delta;</span><br><span class="line">    if (updateVel) </span><br><span class="line">        for (int i = 0; i &lt; points.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            points[i].z *= damp;</span><br><span class="line">            points[i].x += dt * points[i].z;</span><br><span class="line">        &#125;</span><br><span class="line">    for (int i = 0; i &lt; iteration; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        for (int j = 0; j &lt; constrains.Length; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            int num = constrains[j], cnt = 0; delta = 0;</span><br><span class="line">            while (num &gt; 0)</span><br><span class="line">            &#123;</span><br><span class="line">                switch (num &amp; 7)</span><br><span class="line">                &#123;</span><br><span class="line">                    case 1:</span><br><span class="line">                        delta += 0.5f * (points[j + gridSize].x - points[j].x);</span><br><span class="line">                        cnt++; break;</span><br><span class="line">                    case 2:</span><br><span class="line">                        delta += 0.5f * (points[j - gridSize].x - points[j].x);</span><br><span class="line">                        cnt++; break;</span><br><span class="line">                    case 3:</span><br><span class="line">                        delta += 0.5f * (points[j + 1].x - points[j].x);</span><br><span class="line">                        cnt++; break;</span><br><span class="line">                    case 4:</span><br><span class="line">                        delta += 0.5f * (points[j - 1].x - points[j].x);</span><br><span class="line">                        cnt++; break;</span><br><span class="line">                &#125;</span><br><span class="line">                num &gt;&gt;= 3;</span><br><span class="line">            &#125;</span><br><span class="line">            points[j].x += delta / cnt;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // Volumn Conservation</span><br><span class="line">    delta = 0;</span><br><span class="line">    for (int i = 0; i &lt; points.Length; i++) </span><br><span class="line">        delta += points[i].x; delta /= points.Length;</span><br><span class="line">    for (int i = 0; i &lt; points.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        points[i].x -= delta;</span><br><span class="line">        points[i].z = (points[i].x - points[i].y) / dt;</span><br><span class="line">        points[i].y = points[i].x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Calculate Normal</span><br><span class="line">    for (int i = 0; i &lt; points.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        int x = i / gridSize, y = i % gridSize,</span><br><span class="line">            xl = Mathf.Max(x - 1, 0), xr = Mathf.Min(x + 1, gridSize - 1),</span><br><span class="line">            yl = Mathf.Max(y - 1, 0), yr = Mathf.Min(y + 1, gridSize - 1);</span><br><span class="line"></span><br><span class="line">        float dx = (points[y * gridSize + xr].x - points[y * gridSize + xl].x) / (xr - xl),</span><br><span class="line">            dz = (points[yr * gridSize + x].x - points[yl * gridSize + x].x) / (yr - yl);</span><br><span class="line"></span><br><span class="line">        Vector3 normal = new Vector3(dx, 1.0f, dz).normalized;</span><br><span class="line">        datas[i] = new Vector4(points[i].x, normal.x, normal.y, normal.z);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dataBuffer.SetData(datas);</span><br><span class="line">    material.SetBuffer(&quot;_DataBuffer&quot;, dataBuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Surface-construction"><a href="#Surface-construction" class="headerlink" title="Surface construction"></a>Surface construction</h4><p>The task of the shader is to use the spring mass mesh height and normal information. Lerp is definitely not an option. I tried SmoothStep, but it even was not as good as Lerp. Finally, I had to use CosStep, which I wrote myself. I used CosStep for mean diffusion before. I suggest Unity integrate trigonometric function interpolation as well. I am too lazy to write it myself every time. I will only show the cosine interpolation of height. The normal part is exactly the same, so there is no need to fill the word count here.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">int _GridSize;</span><br><span class="line">StructuredBuffer&lt;float4&gt; _DataBuffer; // x: height yzw: normal</span><br><span class="line"></span><br><span class="line">float CosStep(float a, float b, float t)</span><br><span class="line">&#123;</span><br><span class="line">    float f = (1 - cos(t * PI)) * 0.5;</span><br><span class="line">    return a * (1 - f) + b * f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float4 frag(v2f i) : SV_Target</span><br><span class="line">&#123;</span><br><span class="line">    int xl = floor(i.uv.x * _GridSize), xr = xl + 1,</span><br><span class="line">        yl = floor(i.uv.y * _GridSize), yr = yl + 1;</span><br><span class="line">    float xf = frac(i.uv.x * _GridSize), yf = frac(i.uv.y * _GridSize),</span><br><span class="line">        height = CosStep(CosStep(_DataBuffer[yl * _GridSize + xl].x, _DataBuffer[yl * _GridSize + xr].x, xf),</span><br><span class="line">        CosStep(_DataBuffer[yr * _GridSize + xl].x, _DataBuffer[yr * _GridSize + xr].x, xf), yf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Written-behind"><a href="#Written-behind" class="headerlink" title="Written behind"></a>Written behind</h3><p>As usual, we end with the finished product, which also adds lots of details. The GIF resolution limit makes it hard to see bubbles. MiHoYo probably used the same exaggerated animation curve control as Yidi1D, and the spring particle grid is very physical. In terms of performance, a 4x4 simple grid plus 8 iterations doesn’t cost much, feels like it can be used for small liquid surfaces that require solid-liquid coupling.</p>
<p><img src="https://picx.zhimg.com/80/v2-46854a49290b4bccca5e832968908b03_720w.gif?source=d16d100b" alt="img"></p>
<p>The rest are just some random thoughts. The spring recruitment and summer internship have started. I will take a look at the UE physics source code and then prepare to apply for foreign companies and overseas companies. After all, this study abroad is also for WLB. MiHoYo really does what it pays. The Final Lesson, Meteoric Salvation, Everlasting Flames, Elysian Realm, and GraduationTrip of Honkai Impact 3 of Honkai Impact 3, Xianzhou Luofu, Penacony, Amphoreus of Honkai Star Rail. I hope MiHoYo can continue to prosper, and I will try my best to leave my own story in the end.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://ayinzhang.github.io/en">YiZhen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://ayinzhang.github.io/en/2025/03/05/2025-3-6-Honkai%20Star%20Rail%20Bartending/">https://ayinzhang.github.io/en/2025/03/05/2025-3-6-Honkai%20Star%20Rail%20Bartending/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/en/tags/Animated-simulation/">Animated simulation</a><a class="post-meta__tags" href="/en/tags/Graphics-Rendering/">Graphics Rendering</a></div><div class="post_share"><div class="social-share" data-image="https://pica.zhimg.com/70/v2-ab5b1cb243e07c5bbd1fdaddbed0a19e_1440w.avis?source=172ae18b&amp;biz_tag=Post" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>Sponsor</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/en/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/en/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/en/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/en/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/en/2025/05/09/2025-5-10-ICEY/" title="ICEY"><img class="cover" src="https://pic1.zhimg.com/80/v2-61c4e8dc421ca9ea137777d60867148c_720w.png" onerror="onerror=null;src='/en/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">ICEY</div></div></a></div><div class="next-post pull-right"><a href="/en/2025/02/12/2025-2-13-Water%20Caustics/" title="Water Caustics Rendering and Simulation"><img class="cover" src="https://pic1.zhimg.com/v2-eb779799112e9cf076a749de09ee543f_720w.png?source=d16d100b" onerror="onerror=null;src='/en/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">Water Caustics Rendering and Simulation</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/en/2025/02/12/2025-2-13-Water%20Caustics/" title="Water Caustics Rendering and Simulation"><img class="cover" src="https://pic1.zhimg.com/v2-eb779799112e9cf076a749de09ee543f_720w.png?source=d16d100b" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-13</div><div class="title">Water Caustics Rendering and Simulation</div></div></a></div><div><a href="/en/2022/12/24/2022-12-25-GAMES201/" title="GAMES201"><img class="cover" src="https://picx.zhimg.com/70/v2-323f384f9aa03b42d04343c85cb302fd_1440w.avis?source=172ae18b&biz_tag=Post" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-25</div><div class="title">GAMES201</div></div></a></div><div><a href="/en/2023/03/08/2023-3-9-Dynamic%20Bone%20Simple%20Analysis/" title="Dynamic Bone Simple Analysis"><img class="cover" src="https://picx.zhimg.com/70/v2-4abfce4c3122d36ef9506fb9608c7077_1440w.avis?source=172ae18b&biz_tag=Post" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-09</div><div class="title">Dynamic Bone Simple Analysis</div></div></a></div><div><a href="/en/2024/11/25/2024-11-26-Unity%20Physics%20Simulation%20Method%20Environment%20Hodgepodge/" title="Unity Euler and Position based Simulation Methods together with languages Hodgepodge"><img class="cover" src="https://pica.zhimg.com/70/v2-f6bca2be2f713b9248d0def917d533b3_1440w.avis?source=172ae18b&biz_tag=Post" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-26</div><div class="title">Unity Euler and Position based Simulation Methods together with languages Hodgepodge</div></div></a></div><div><a href="/en/2025/05/15/2025-5-16-Rigidbody%20Simulation%20and%20Fracture/" title="Rigidbody Simulation and Fracture"><img class="cover" src="https://pic1.zhimg.com/v2-b6a67053dcd8bd0651dcfe15936599e2_720w.png?source=d16d100b" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-16</div><div class="title">Rigidbody Simulation and Fracture</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/en/img/me.jpg" onerror="this.onerror=null;this.src='/en/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">YiZhen</div><div class="author-info__description">End Apocalypse</div></div><div class="card-info-data site-data is-center"><a href="/en/archives/"><div class="headline">Articles</div><div class="length-num">21</div></a><a href="/en/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/en/categories/"><div class="headline">Categories</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ayinzhang"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ayinzhang" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1242857339@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">It's just a little wind frost</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Written-before"><span class="toc-number">1.</span> <span class="toc-text">Written before</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Patent-Introduction"><span class="toc-number">2.</span> <span class="toc-text">Patent Introduction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Real-time-rendering"><span class="toc-number">3.</span> <span class="toc-text">Real-time rendering</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stipple-transparency"><span class="toc-number">3.1.</span> <span class="toc-text">Stipple transparency</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Liquid-lerp"><span class="toc-number">3.2.</span> <span class="toc-text">Liquid lerp</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Physics-simulation"><span class="toc-number">4.</span> <span class="toc-text">Physics simulation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Physical-Interaction"><span class="toc-number">4.1.</span> <span class="toc-text">Physical Interaction</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Surface-construction"><span class="toc-number">4.2.</span> <span class="toc-text">Surface construction</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Written-behind"><span class="toc-number">5.</span> <span class="toc-text">Written behind</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/en/2025/05/15/2025-5-16-Rigidbody%20Simulation%20and%20Fracture/" title="Rigidbody Simulation and Fracture"><img src="https://pic1.zhimg.com/v2-b6a67053dcd8bd0651dcfe15936599e2_720w.png?source=d16d100b" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Rigidbody Simulation and Fracture"/></a><div class="content"><a class="title" href="/en/2025/05/15/2025-5-16-Rigidbody%20Simulation%20and%20Fracture/" title="Rigidbody Simulation and Fracture">Rigidbody Simulation and Fracture</a><time datetime="2025-05-15T16:00:00.000Z" title="Created 2025-05-16 00:00:00">2025-05-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2025/05/09/2025-5-10-ICEY/" title="ICEY"><img src="https://pic1.zhimg.com/80/v2-61c4e8dc421ca9ea137777d60867148c_720w.png" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="ICEY"/></a><div class="content"><a class="title" href="/en/2025/05/09/2025-5-10-ICEY/" title="ICEY">ICEY</a><time datetime="2025-05-09T16:00:00.000Z" title="Created 2025-05-10 00:00:00">2025-05-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2025/03/05/2025-3-6-Honkai%20Star%20Rail%20Bartending/" title="Honkai Star Rail Bartending"><img src="https://pica.zhimg.com/70/v2-ab5b1cb243e07c5bbd1fdaddbed0a19e_1440w.avis?source=172ae18b&amp;biz_tag=Post" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Honkai Star Rail Bartending"/></a><div class="content"><a class="title" href="/en/2025/03/05/2025-3-6-Honkai%20Star%20Rail%20Bartending/" title="Honkai Star Rail Bartending">Honkai Star Rail Bartending</a><time datetime="2025-03-05T16:00:00.000Z" title="Created 2025-03-06 00:00:00">2025-03-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2025/02/12/2025-2-13-Water%20Caustics/" title="Water Caustics Rendering and Simulation"><img src="https://pic1.zhimg.com/v2-eb779799112e9cf076a749de09ee543f_720w.png?source=d16d100b" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="Water Caustics Rendering and Simulation"/></a><div class="content"><a class="title" href="/en/2025/02/12/2025-2-13-Water%20Caustics/" title="Water Caustics Rendering and Simulation">Water Caustics Rendering and Simulation</a><time datetime="2025-02-12T16:00:00.000Z" title="Created 2025-02-13 00:00:00">2025-02-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/en/2024/12/21/2024-12-22-XNode%20Simple%20Visual%20Dialogue%20Editor/" title="XNode Introduction and Visual Dialogue Editor"><img src="https://picx.zhimg.com/70/v2-b44e6f5c815f8fcfcc426f0b114edbbd_1440w.avis?source=172ae18b&amp;biz_tag=Post" onerror="this.onerror=null;this.src='/en/img/404.jpg'" alt="XNode Introduction and Visual Dialogue Editor"/></a><div class="content"><a class="title" href="/en/2024/12/21/2024-12-22-XNode%20Simple%20Visual%20Dialogue%20Editor/" title="XNode Introduction and Visual Dialogue Editor">XNode Introduction and Visual Dialogue Editor</a><time datetime="2024-12-21T16:00:00.000Z" title="Created 2024-12-22 00:00:00">2024-12-22</time></div></div></div></div></div></div></main><footer id="footer" style="background: rgba(1,1,1,0)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By YiZhen</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="translateLink" type="button" title="Toggle Between Chinese And English">EN</button><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/en/js/utils.js?v=4.13.0"></script><script src="/en/js/main.js?v=4.13.0"></script><script src="/en/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(()=>{
  const getGiscusTheme = theme => {
    return theme === 'dark' ? 'dark' : 'light'
  }

  const loadGiscus = () => {
    const config = Object.assign({
      src: 'https://giscus.app/client.js',
      'data-repo': 'ayinzhang/ayinzhang.github.io',
      'data-repo-id': 'R_kgDOKl3Dog',
      'data-category-id': 'DIC_kwDOKl3Dos4CaqXe',
      'data-mapping': 'pathname',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true
    },null)

    const ele = document.createElement('script')
    for (let key in config) {
      ele.setAttribute(key, config[key])
    }
    document.getElementById('giscus-wrap').appendChild(ele)
  }

  const changeGiscusTheme = theme => {
    const sendMessage = message => {
      const iframe = document.querySelector('iframe.giscus-frame')
      if (!iframe) return
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
    }

    sendMessage({
      setConfig: {
        theme: getGiscusTheme(theme)
      }
    });
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment= loadGiscus
  }
})()</script></div><script data-pjax src="/en/self/btf.js"></script><script data-pjax src="/en/self/tw_en.js"></script><div class="aplayer no-destroy" data-id="8985244058" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false"> </div><script id="canvas_nest" defer="defer" color="0,0,0" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="true" data-text="且行且看,尽力而为,不要害怕,不要后悔" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/en/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/en/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/en/live2dw/assets/elica.model.json"},"display":{"superSample":2,"width":200,"height":400,"position":"right","hOffset":20,"vOffset":-130},"mobile":{"show":false,"scale":0.3},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false});</script></body></html>